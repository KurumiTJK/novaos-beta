<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SwordGate Test Harness v10</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      min-height: 100vh;
    }
    
    /* Header */
    .header {
      background: #1a1a1a;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #333;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo { font-size: 24px; }
    
    .title {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
    }
    
    .mode-badge {
      background: #333;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      color: #888;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
    }
    
    .status-dot.connected { background: #22c55e; }
    .status-dot.error { background: #ef4444; }
    
    .status-text { font-size: 13px; color: #888; }
    
    /* URL Bar */
    .url-bar {
      background: #1a1a1a;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #333;
    }
    
    .url-bar label { font-size: 13px; color: #888; }
    
    .url-bar input {
      flex: 1;
      max-width: 400px;
      background: #0f0f0f;
      border: 1px solid #333;
      padding: 8px 12px;
      border-radius: 6px;
      color: #fff;
      font-size: 13px;
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary { background: #3b82f6; color: #fff; }
    .btn-primary:hover { background: #2563eb; }
    .btn-success { background: #22c55e; color: #fff; }
    .btn-success:hover { background: #16a34a; }
    .btn-secondary { background: #333; color: #e0e0e0; }
    .btn-secondary:hover { background: #444; }
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-danger:hover { background: #dc2626; }
    .btn-ghost { background: transparent; color: #888; }
    .btn-ghost:hover { background: #333; color: #fff; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
    }
    .status-badge.success { background: #166534; color: #86efac; }
    .status-badge.warning { background: #854d0e; color: #fde047; }
    .status-badge.secondary { background: #333; color: #888; }
    
    /* Main Layout */
    .main {
      display: grid;
      grid-template-columns: 300px 1fr 350px;
      height: calc(100vh - 100px);
    }
    
    .panel {
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .panel:last-child { border-right: none; }
    
    .panel-header {
      padding: 12px 16px;
      border-bottom: 1px solid #333;
      background: #1a1a1a;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .panel-title { display: flex; align-items: center; gap: 8px; }
    
    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      padding: 8px 16px;
      background: #1a1a1a;
      border-bottom: 1px solid #333;
    }
    
    .tab {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      color: #888;
      transition: all 0.2s;
    }
    
    .tab:hover { color: #fff; background: #333; }
    .tab.active { color: #fff; background: #3b82f6; }
    
    /* Chat Panel */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .message {
      padding: 12px;
      border-radius: 8px;
      max-width: 90%;
    }
    
    .message.user {
      background: #3b82f6;
      color: #fff;
      align-self: flex-end;
    }
    
    .message.assistant {
      background: #262626;
      align-self: flex-start;
    }
    
    .message.system {
      background: #1e3a5f;
      align-self: center;
      font-size: 12px;
      color: #93c5fd;
    }
    
    /* Markdown Styles (for assistant messages) */
    .message.assistant h1,
    .message.assistant h2,
    .message.assistant h3 {
      color: #fff;
      margin: 16px 0 8px 0;
      font-weight: 600;
    }
    .message.assistant h1 { font-size: 18px; }
    .message.assistant h2 { font-size: 16px; }
    .message.assistant h3 { font-size: 15px; }
    
    .message.assistant p {
      margin: 8px 0;
      line-height: 1.5;
    }
    
    .message.assistant ul,
    .message.assistant ol {
      margin: 8px 0 8px 20px;
      padding: 0;
    }
    
    .message.assistant li {
      margin: 4px 0;
      line-height: 1.4;
    }
    
    .message.assistant strong {
      color: #fff;
      font-weight: 600;
    }
    
    .message.assistant em {
      font-style: italic;
      color: #ccc;
    }
    
    .message.assistant code {
      background: #1a1a1a;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
    }
    
    .message.assistant pre {
      background: #1a1a1a;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 8px 0;
    }
    
    .message.assistant pre code {
      background: none;
      padding: 0;
    }
    
    .message.assistant hr {
      border: none;
      border-top: 1px solid #444;
      margin: 12px 0;
    }
    
    .message.assistant blockquote {
      border-left: 3px solid #3b82f6;
      padding-left: 12px;
      margin: 8px 0;
      color: #aaa;
    }
    
    .stance-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    
    .stance-lens { background: #8b5cf6; color: #fff; }
    .stance-sword { background: #22c55e; color: #fff; }
    .stance-shield { background: #3b82f6; color: #fff; }
    
    .chat-input-area {
      padding: 12px;
      border-top: 1px solid #333;
      background: #1a1a1a;
    }
    
    .chat-input-row {
      display: flex;
      gap: 8px;
    }
    
    .chat-input {
      flex: 1;
      background: #0f0f0f;
      border: 1px solid #333;
      padding: 10px 14px;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }
    
    .quick-messages {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    
    .quick-msg {
      padding: 6px 10px;
      background: #262626;
      border: 1px solid #333;
      border-radius: 6px;
      font-size: 12px;
      color: #888;
      cursor: pointer;
    }
    
    .quick-msg:hover { background: #333; color: #fff; }
    
    /* Status Card */
    .status-card {
      background: #1a2e1a;
      border: 1px solid #2d4a2d;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .status-card.error {
      background: #2e1a1a;
      border-color: #4a2d2d;
    }
    
    .status-card .label {
      font-size: 11px;
      color: #22c55e;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .status-card.error .label { color: #ef4444; }
    
    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: #888;
      margin-bottom: 8px;
    }
    
    .empty-state-text {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }
    
    /* Plans Grid */
    .plans-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .plan-card {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 16px;
      transition: all 0.2s;
    }
    
    .plan-card:hover { border-color: #555; }
    .plan-card.active { border-color: #22c55e; background: #1a2e1a; }
    
    .plan-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .plan-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }
    
    .plan-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .plan-status.active { background: #22c55e22; color: #22c55e; }
    .plan-status.designing { background: #f59e0b22; color: #f59e0b; }
    
    .plan-capstone {
      font-size: 13px;
      color: #888;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .plan-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: #666;
      margin-bottom: 12px;
    }
    
    .plan-progress {
      height: 4px;
      background: #333;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    
    .plan-progress-bar {
      height: 100%;
      background: #22c55e;
      border-radius: 2px;
    }
    
    .plan-actions {
      display: flex;
      gap: 8px;
    }
    
    /* Today View */
    .today-card {
      background: linear-gradient(135deg, #1a2e1a 0%, #1a1a2e 100%);
      border: 1px solid #2d4a2d;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .today-header {
      font-size: 14px;
      color: #22c55e;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .today-title {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
    }
    
    .today-meta {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #888;
      margin-bottom: 16px;
    }
    
    .today-node {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px;
    }
    
    .today-node-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
    }
    
    .today-node-objective {
      font-size: 13px;
      color: #888;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .route-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .route-badge.recall { background: #8b5cf622; color: #8b5cf6; }
    .route-badge.practice { background: #3b82f622; color: #3b82f6; }
    .route-badge.apply { background: #22c55e22; color: #22c55e; }
    .route-badge.build { background: #f59e0b22; color: #f59e0b; }
    .route-badge.diagnose { background: #ef444422; color: #ef4444; }
    .route-badge.refine { background: #ec489922; color: #ec4899; }
    .route-badge.plan { background: #6366f122; color: #6366f1; }
    
    /* Explore View */
    .explore-container {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .explore-header {
      padding: 16px;
      background: linear-gradient(135deg, #1e3a5f 0%, #1a2e1a 100%);
      border-bottom: 1px solid #333;
    }
    
    .explore-phase {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    
    .phase-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .phase-badge.orient { background: #3b82f6; color: #fff; }
    .phase-badge.clarify { background: #8b5cf6; color: #fff; }
    .phase-badge.define-goal { background: #22c55e; color: #fff; }
    
    .explore-title {
      font-size: 14px;
      color: #93c5fd;
    }
    
    /* Explore Chat (Part 1: Orient) */
    .explore-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .explore-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .explore-input-area {
      padding: 12px 16px;
      border-top: 1px solid #333;
      background: #1a1a1a;
    }
    
    .explore-input-row {
      display: flex;
      gap: 8px;
    }
    
    .explore-input {
      flex: 1;
      background: #0f0f0f;
      border: 1px solid #333;
      padding: 12px 16px;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }
    
    .explore-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      justify-content: flex-end;
    }
    
    /* Clarify Form (Part 2) */
    .clarify-form {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .clarify-field {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .clarify-field:hover { border-color: #555; }
    .clarify-field.editing { border-color: #3b82f6; background: #1a1a2e; }
    .clarify-field.empty { border-color: #f59e0b44; background: #2e2a1a; }
    .clarify-field.filled { border-color: #22c55e44; }
    
    .clarify-field-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .clarify-field-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #888;
    }
    
    .clarify-field-label .icon { font-size: 16px; }
    
    .clarify-field-source {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #333;
      color: #888;
    }
    
    .clarify-field-source.extracted { background: #3b82f622; color: #3b82f6; }
    .clarify-field-source.user_edited { background: #22c55e22; color: #22c55e; }
    
    .clarify-field-value {
      font-size: 14px;
      color: #e0e0e0;
      line-height: 1.5;
    }
    
    .clarify-field-empty {
      font-size: 14px;
      color: #666;
      font-style: italic;
    }
    
    .clarify-field-input {
      width: 100%;
      background: #0f0f0f;
      border: 1px solid #444;
      padding: 10px 12px;
      border-radius: 6px;
      color: #fff;
      font-size: 14px;
      resize: vertical;
      min-height: 60px;
    }
    
    .clarify-field-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      justify-content: flex-end;
    }
    
    .clarify-constraints {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .constraint-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: #333;
      border-radius: 20px;
      font-size: 12px;
    }
    
    .constraint-remove {
      cursor: pointer;
      color: #888;
    }
    
    .constraint-remove:hover { color: #ef4444; }
    
    .add-constraint {
      padding: 6px 12px;
      background: #262626;
      border: 1px dashed #444;
      border-radius: 20px;
      font-size: 12px;
      color: #888;
      cursor: pointer;
    }
    
    .add-constraint:hover { background: #333; color: #fff; }
    
    /* Preset buttons */
    .clarify-presets {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #333;
    }
    
    .clarify-presets.constraint-presets {
      margin-top: 12px;
      padding-top: 12px;
    }
    
    .preset-btn {
      padding: 6px 12px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 6px;
      font-size: 12px;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .preset-btn:hover {
      background: #334155;
      color: #fff;
      border-color: #3b82f6;
    }
    
    .clarify-actions {
      padding: 16px;
      border-top: 1px solid #333;
      background: #1a1a1a;
      display: flex;
      justify-content: space-between;
    }
    
    /* Required indicator */
    .required { color: #ef4444; }
    
    /* API Logs */
    .log-entry {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #262626;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 11px;
    }
    
    .log-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    
    .log-time { color: #666; }
    
    .log-method {
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }
    
    .log-method.GET { background: #22c55e22; color: #22c55e; }
    .log-method.POST { background: #3b82f622; color: #3b82f6; }
    .log-method.PATCH { background: #f59e0b22; color: #f59e0b; }
    .log-method.DELETE { background: #ef444422; color: #ef4444; }
    
    .log-path { color: #e0e0e0; }
    
    .log-status {
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }
    
    .log-status.success { background: #22c55e22; color: #22c55e; }
    .log-status.error { background: #ef444422; color: #ef4444; }
    
    .log-body {
      background: #0f0f0f;
      border-radius: 4px;
      padding: 8px;
      color: #888;
      max-height: 120px;
      overflow-y: auto;
    }
    
    .log-body pre {
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    /* Quick Actions */
    .quick-actions {
      padding: 12px;
      border-top: 1px solid #333;
      background: #1a1a1a;
      flex-shrink: 0;
    }
    
    .quick-actions-label {
      font-size: 11px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    
    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #888;
    }
    
    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #333;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 12px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Nodes List */
    .nodes-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }
    
    .node-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #0f0f0f;
      border-radius: 6px;
      font-size: 13px;
    }
    
    .node-order {
      width: 24px;
      height: 24px;
      background: #333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
    }
    
    .node-title { flex: 1; color: #e0e0e0; }
    
    .node-route {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .node-route.recall { background: #8b5cf622; color: #8b5cf6; }
    .node-route.practice { background: #3b82f622; color: #3b82f6; }
    .node-route.apply { background: #22c55e22; color: #22c55e; }
    .node-route.build { background: #f59e0b22; color: #f59e0b; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DEFINE GOAL STYLES (NEW)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .define-goal-container {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .define-goal-header {
      padding: 16px;
      background: linear-gradient(135deg, #1a2e1a 0%, #1e3a1e 100%);
      border-bottom: 1px solid #2d4a2d;
    }
    
    .define-goal-title {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 4px;
    }
    
    .define-goal-subtitle {
      font-size: 13px;
      color: #22c55e;
    }
    
    .define-goal-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .define-goal-actions {
      padding: 16px;
      border-top: 1px solid #333;
      background: #1a1a1a;
      display: flex;
      justify-content: space-between;
    }
    
    /* Generation Progress */
    .generation-progress {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .generation-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid #262626;
    }
    
    .generation-step:last-child { border-bottom: none; }
    
    .step-indicator {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }
    
    .step-indicator.pending { background: #333; color: #666; }
    .step-indicator.active { background: #3b82f6; color: #fff; animation: pulse 1.5s infinite; }
    .step-indicator.complete { background: #22c55e; color: #fff; }
    .step-indicator.error { background: #ef4444; color: #fff; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .step-info { flex: 1; }
    .step-title { font-size: 14px; font-weight: 600; color: #e0e0e0; }
    .step-subtitle { font-size: 12px; color: #666; }
    
    /* Capstone Section */
    .capstone-section {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .capstone-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .capstone-title {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
    }
    
    .capstone-statement {
      font-size: 14px;
      color: #e0e0e0;
      line-height: 1.6;
      margin-bottom: 16px;
      padding: 12px;
      background: #0f0f0f;
      border-radius: 6px;
      border-left: 3px solid #22c55e;
    }
    
    .capstone-criteria {
      margin-bottom: 16px;
    }
    
    .criteria-title {
      font-size: 12px;
      font-weight: 600;
      color: #888;
      margin-bottom: 8px;
    }
    
    .criteria-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .criteria-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #e0e0e0;
    }
    
    .criteria-item::before {
      content: 'âœ“';
      color: #22c55e;
      font-weight: 600;
    }
    
    .capstone-meta {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #888;
    }
    
    /* Subskills Section */
    .subskills-section {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .subskills-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .subskills-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }
    
    .subskills-count {
      font-size: 12px;
      color: #888;
    }
    
    .subskill-card {
      background: #0f0f0f;
      border: 1px solid #262626;
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    
    .subskill-card:hover { border-color: #444; }
    .subskill-card.skip { opacity: 0.5; }
    .subskill-card.assess { border-left: 3px solid #f59e0b; }
    
    .subskill-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    
    .subskill-title {
      font-size: 14px;
      font-weight: 600;
      color: #e0e0e0;
    }
    
    .subskill-badges {
      display: flex;
      gap: 6px;
    }
    
    .subskill-type {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .subskill-type.concepts { background: #8b5cf622; color: #8b5cf6; }
    .subskill-type.procedures { background: #3b82f622; color: #3b82f6; }
    .subskill-type.judgments { background: #ef444422; color: #ef4444; }
    .subskill-type.outputs { background: #f59e0b22; color: #f59e0b; }
    .subskill-type.tool_setup { background: #22c55e22; color: #22c55e; }
    .subskill-type.tool_management { background: #6366f122; color: #6366f1; }
    
    .subskill-desc {
      font-size: 13px;
      color: #888;
      line-height: 1.4;
      margin-bottom: 10px;
    }
    
    .subskill-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .subskill-route {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #666;
    }
    
    .subskill-status {
      display: flex;
      gap: 4px;
    }
    
    .status-btn {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
    }
    
    .status-btn.learn { background: #22c55e22; color: #22c55e; border-color: #22c55e44; }
    .status-btn.skip { background: #333; color: #888; border-color: #444; }
    .status-btn.assess { background: #f59e0b22; color: #f59e0b; border-color: #f59e0b44; }
    
    .status-btn.active { border-color: currentColor; }
    .status-btn:hover { opacity: 0.8; }
    
    /* Summary Section */
    .summary-section {
      background: linear-gradient(135deg, #1a2e1a 0%, #1e3a1e 100%);
      border: 1px solid #2d4a2d;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .summary-title {
      font-size: 14px;
      font-weight: 600;
      color: #22c55e;
      margin-bottom: 12px;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    
    .summary-stat {
      text-align: center;
    }
    
    .summary-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
    }
    
    .summary-stat-label {
      font-size: 11px;
      color: #888;
    }
    
    /* Reason tooltip */
    .reason-tooltip {
      font-size: 11px;
      color: #666;
      font-style: italic;
      margin-top: 4px;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RUNNER STYLES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .runner-section {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .runner-section h4 {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 12px;
    }
    
    .runner-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .runner-header h3 {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      margin: 0;
    }
    
    .runner-progress {
      height: 6px;
      background: #333;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .runner-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #3b82f6);
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .runner-meta {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #888;
    }
    
    .runner-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .runner-stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    
    .runner-stat {
      text-align: center;
      padding: 12px;
      background: #0f0f0f;
      border-radius: 8px;
    }
    
    .runner-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
    }
    
    .runner-stat-label {
      font-size: 11px;
      color: #888;
      margin-top: 4px;
    }
    
    .runner-subskills-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .runner-subskill-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: #0f0f0f;
      border: 1px solid #262626;
      border-radius: 6px;
    }
    
    .runner-subskill-item.mastered {
      border-color: #22c55e44;
      background: #0f1a0f;
    }
    
    .runner-subskill-item.active {
      border-color: #3b82f644;
      background: #0f0f1a;
    }
    
    .runner-subskill-item.skipped {
      opacity: 0.5;
    }
    
    .runner-subskill-num {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #333;
      border-radius: 50%;
      font-size: 11px;
      font-weight: 600;
      color: #888;
    }
    
    .runner-subskill-title {
      flex: 1;
      font-size: 13px;
      color: #e0e0e0;
    }
    
    /* Lesson Content */
    .lesson-content {
      margin-bottom: 16px;
    }
    
    .lesson-section {
      margin-bottom: 12px;
    }
    
    .lesson-section h5 {
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 6px;
    }
    
    .lesson-section p {
      font-size: 13px;
      color: #aaa;
      line-height: 1.5;
    }
    
    .lesson-section ul {
      margin: 8px 0 0 16px;
      padding: 0;
    }
    
    .lesson-section li {
      font-size: 12px;
      color: #888;
      margin-bottom: 4px;
    }
    
    .lesson-activities {
      margin-bottom: 16px;
    }
    
    .lesson-activities h5 {
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
    }
    
    .lesson-activity {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      background: #0f0f0f;
      border-radius: 6px;
      margin-bottom: 6px;
    }
    
    .lesson-activity.completed {
      opacity: 0.5;
      text-decoration: line-through;
    }
    
    .activity-type {
      padding: 2px 8px;
      background: #333;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      color: #888;
    }
    
    .activity-title {
      flex: 1;
      font-size: 13px;
      color: #e0e0e0;
    }
    
    .activity-time {
      font-size: 11px;
      color: #666;
    }
    
    .lesson-keypoints {
      margin-bottom: 12px;
    }
    
    .lesson-keypoints h5 {
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
    }
    
    .lesson-keypoints ul {
      margin: 0 0 0 16px;
      padding: 0;
    }
    
    .lesson-keypoints li {
      font-size: 12px;
      color: #22c55e;
      margin-bottom: 4px;
    }
    
    /* Knowledge Check */
    .kc-questions {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 12px;
    }
    
    .kc-question {
      padding: 12px;
      background: #0f0f0f;
      border-radius: 8px;
    }
    
    .kc-question-text {
      font-size: 13px;
      color: #e0e0e0;
      margin-bottom: 10px;
    }
    
    .kc-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .kc-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .kc-option:hover {
      border-color: #555;
    }
    
    .kc-option input {
      accent-color: #22c55e;
    }
    
    .kc-option span {
      font-size: 13px;
      color: #aaa;
    }
    
    .btn-warning {
      background: #f59e0b;
      color: #000;
    }
    
    .btn-warning:hover {
      background: #d97706;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <span class="logo">âš”ï¸</span>
      <span class="title">SwordGate Test Harness v10</span>
      <span class="mode-badge">CONNECTED MODE</span>
    </div>
    <div class="header-right">
      <span class="status-dot" id="statusDot"></span>
      <span class="status-text" id="statusText">Disconnected</span>
      <button class="btn btn-danger btn-sm" onclick="reset()">Reset</button>
    </div>
  </div>
  
  <div class="url-bar">
    <label>Backend URL:</label>
    <input type="text" id="baseUrl" value="http://localhost:3000/api/v1">
    <button class="btn btn-primary" onclick="connect()">Connect</button>
  </div>
  
  <div class="main">
    <!-- Left Panel (Chat) -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">ğŸ’¬ Chat (Pipeline Test)</span>
        <button class="btn btn-sm btn-secondary" onclick="newChat()" title="Start a new conversation">+ New Chat</button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="status-card error" id="connectionStatus">
          <div class="label">âœ• CONNECTION FAILED</div>
          <div>Failed to fetch</div>
        </div>
      </div>
      <div class="chat-input-area">
        <div class="chat-input-row">
          <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendChat()">
          <button class="btn btn-primary" onclick="sendChat()">Send</button>
        </div>
        <div class="quick-messages">
          <span class="quick-msg" onclick="sendQuickMessage('I want to learn TypeScript')">I want to learn TypeScript</span>
          <span class="quick-msg" onclick="sendQuickMessage('Teach me guitar')">Teach me guitar</span>
          <span class="quick-msg" onclick="sendQuickMessage('Hello!')">Hello!</span>
        </div>
        <div class="quick-messages" style="margin-top: 4px;">
          <span class="quick-msg" style="border-color: #3b82f6; color: #3b82f6;" onclick="sendQuickMessage('I want to put my emergency fund into meme coins')">ğŸ›¡ï¸ MEDIUM: Meme coins</span>
          <span class="quick-msg" style="border-color: #3b82f6; color: #3b82f6;" onclick="sendQuickMessage('Should I quit my job today without notice?')">ğŸ›¡ï¸ MEDIUM: Quit job</span>
          <span class="quick-msg" style="border-color: #ef4444; color: #ef4444;" onclick="sendQuickMessage('I feel like ending it all')">ğŸ†˜ HIGH: Crisis</span>
        </div>
      </div>
    </div>
    
    <!-- Center Panel (Tabs) -->
    <div class="panel">
      <div class="tabs">
        <div class="tab" id="tabExplore" onclick="switchTab('explore')">ğŸ” Explore</div>
        <div class="tab" id="tabDefineGoal" onclick="switchTab('defineGoal')">ğŸ¯ Define Goal</div>
        <div class="tab" id="tabReview" onclick="switchTab('review')">ğŸ“‹ Review</div>
        <div class="tab active" id="tabDesigner" onclick="switchTab('designer')">ğŸ¨ Designer</div>
        <div class="tab" id="tabPlans" onclick="switchTab('plans')">ğŸ“š Plans</div>
        <div class="tab" id="tabToday" onclick="switchTab('today')">ğŸ“… Today</div>
        <div class="tab" id="tabRunner" onclick="switchTab('runner')">ğŸƒ Runner</div>
      </div>
      
      <!-- Explore View -->
      <div class="panel-content" id="viewExplore" style="display: none; padding: 0;">
        <div class="explore-container" id="exploreContainer">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ”</div>
            <div class="empty-state-title">Start Exploring</div>
            <div class="empty-state-text">Have a conversation to discover what you want to learn</div>
            <button class="btn btn-success" onclick="startExplore()">Start Exploration</button>
            <div style="margin-top: 12px;">
              <input type="text" id="exploreTopic" placeholder="Optional: Enter a topic" style="background: #0f0f0f; border: 1px solid #333; padding: 8px 12px; border-radius: 6px; color: #fff; width: 200px;">
            </div>
          </div>
        </div>
      </div>
      
      <!-- Define Goal View (NEW) -->
      <div class="panel-content" id="viewDefineGoal" style="display: none; padding: 0;">
        <div class="define-goal-container" id="defineGoalContainer">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ¯</div>
            <div class="empty-state-title">Define Your Learning Goal</div>
            <div class="empty-state-text">Complete Exploration first to generate your learning plan</div>
            <button class="btn btn-ghost" onclick="switchTab('explore')">â† Go to Explore</button>
          </div>
        </div>
      </div>
      
      <!-- Review View (NEW) -->
      <div class="panel-content" id="viewReview" style="display: none; padding: 0;">
        <div class="review-container" id="reviewContainer">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <div class="empty-state-title">Review Your Plan</div>
            <div class="empty-state-text">Complete Define Goal first to review your plan</div>
            <button class="btn btn-ghost" onclick="switchTab('defineGoal')">â† Go to Define Goal</button>
          </div>
        </div>
      </div>
      
      <!-- Designer View -->
      <div class="panel-content" id="viewDesigner">
        <div id="designerContent">
          <div class="empty-state">
            <div class="empty-state-icon">âš”ï¸</div>
            <div class="empty-state-title">No Active Designer Session</div>
            <div class="empty-state-text">Start a design session to create a learning plan</div>
            <button class="btn btn-success" onclick="startDesigner()">Start Designer (TypeScript)</button>
          </div>
        </div>
      </div>
      
      <!-- Plans View -->
      <div class="panel-content" id="viewPlans" style="display: none;">
        <div id="plansContent">
          <div class="loading">
            <div class="spinner"></div>
            <span>Loading plans...</span>
          </div>
        </div>
      </div>
      
      <!-- Today View -->
      <div class="panel-content" id="viewToday" style="display: none;">
        <div id="todayContent">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“…</div>
            <div class="empty-state-title">No Active Learning</div>
            <div class="empty-state-text">Activate a plan to see today's learning content</div>
          </div>
        </div>
      </div>
      
      <!-- Runner View (NEW) -->
      <div class="panel-content" id="viewRunner" style="display: none;">
        <div id="runnerContent">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸƒ</div>
            <div class="empty-state-title">Lesson Runner</div>
            <div class="empty-state-text">Connect and activate a plan to test the Lesson Runner</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- API Logs Panel -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">ğŸ“‹ API Logs</span>
        <button class="btn btn-ghost btn-sm" onclick="clearLogs()">Clear</button>
      </div>
      <div class="panel-content" id="apiLogs"></div>
      <div class="quick-actions">
        <div class="quick-actions-label">Quick API Calls</div>
        <div class="quick-actions-grid">
          <button class="btn btn-secondary btn-sm" onclick="callApi('GET', '/health')">Health</button>
          <button class="btn btn-secondary btn-sm" onclick="callApi('GET', '/auth/status')">Status</button>
          <button class="btn btn-secondary btn-sm" onclick="callApi('GET', '/sword')">Sword State</button>
          <button class="btn btn-secondary btn-sm" onclick="callApi('GET', '/sword/today')">Today</button>
          <button class="btn btn-secondary btn-sm" onclick="loadPlansButton()">Plans</button>
          <button class="btn btn-secondary btn-sm" onclick="callApi('GET', '/sword/goal')">Goal State</button>
        </div>
        <div class="quick-actions-label" style="margin-top: 12px;">Runner API Calls</div>
        <div class="quick-actions-grid">
          <button class="btn btn-secondary btn-sm" onclick="callApi('GET', '/sword/stats')">Stats</button>
          <button class="btn btn-secondary btn-sm" onclick="switchTab('runner')">Runner Tab</button>
        </div>
        <div class="quick-actions-label" style="margin-top: 12px;">Shield API Calls</div>
        <div class="quick-actions-grid">
          <button class="btn btn-secondary btn-sm" style="border-color: #3b82f6;" onclick="checkShieldStatus()">Shield Status</button>
          <button class="btn btn-secondary btn-sm" style="border-color: #3b82f6;" onclick="callApi('GET', '/shield/status')">GET /shield/status</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let state = {
      baseUrl: 'http://localhost:3000/api/v1',
      token: null,
      apiKey: null,
      userId: null,
      connected: false,
      conversationId: null,
      forceNewConversation: false, // When true, next message starts fresh
      currentTab: 'designer',
      plans: [],
      designerSession: null,
      // Explore state
      exploreSessionId: null,
      explorePart: null, // 'orient' | 'clarify'
      exploreMessages: [],
      exploreExtracted: null,
      exploreMissing: [],
      exploreFieldSources: {},
      editingField: null,
      // Define Goal state (NEW)
      defineGoalState: null, // { capstone, subskills, routing, summary }
      defineGoalGenerating: false,
      defineGoalStep: 0, // 0=not started, 1=capstone, 2=subskills, 3=routing, 4=done
      // Review state (NEW)
      reviewData: null, // { capstone, subskills, stats }
      // Runner state (NEW)
      runnerToday: null,
      runnerStats: null,
      runnerSubskills: [],
      runnerCurrentSubskill: null,
      runnerDailyLesson: null,
      runnerKnowledgeCheck: null,
      // Shield state (NEW)
      pendingShieldWarning: null, // { activationId, warningMessage, originalMessage }
    };
    
    // Initialize
    document.getElementById('baseUrl').value = state.baseUrl;
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MARKDOWN RENDERER (using marked.js)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Load marked.js from CDN
    const markedScript = document.createElement('script');
    markedScript.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
    document.head.appendChild(markedScript);
    
    function renderMarkdown(text) {
      if (typeof marked !== 'undefined') {
        return marked.parse(text);
      }
      return text
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB SWITCHING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function switchTab(tab) {
      state.currentTab = tab;
      
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      const tabId = 'tab' + tab.charAt(0).toUpperCase() + tab.slice(1);
      const tabEl = document.getElementById(tabId);
      if (tabEl) tabEl.classList.add('active');
      
      document.getElementById('viewExplore').style.display = tab === 'explore' ? 'block' : 'none';
      document.getElementById('viewDefineGoal').style.display = tab === 'defineGoal' ? 'block' : 'none';
      document.getElementById('viewReview').style.display = tab === 'review' ? 'block' : 'none';
      document.getElementById('viewDesigner').style.display = tab === 'designer' ? 'block' : 'none';
      document.getElementById('viewPlans').style.display = tab === 'plans' ? 'block' : 'none';
      document.getElementById('viewToday').style.display = tab === 'today' ? 'block' : 'none';
      document.getElementById('viewRunner').style.display = tab === 'runner' ? 'block' : 'none';
      
      if (tab === 'plans') loadPlans();
      if (tab === 'today') loadToday();
      if (tab === 'designer') loadDesigner();
      if (tab === 'defineGoal') loadDefineGoal();
      if (tab === 'review') loadReview();
      if (tab === 'runner') loadRunner();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONNECTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function connect() {
      state.baseUrl = document.getElementById('baseUrl').value;
      updateStatus('connecting');
      
      try {
        const health = await request('GET', '/health');
        const email = 'test_persistent@example.com';
        const auth = await request('POST', '/auth/register', { email, tier: 'free' });
        
        state.token = auth.token;
        state.apiKey = auth.apiKey;
        state.userId = auth.userId;
        state.connected = true;
        
        updateStatus('connected');
        
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = `
          <div class="status-card">
            <div class="label">âœ“ CONNECTED</div>
            <div>User: ${state.userId}</div>
          </div>
        `;
        
        loadDesigner();
        
      } catch (error) {
        state.connected = false;
        updateStatus('error');
        document.getElementById('connectionStatus').innerHTML = `
          <div class="label">âœ• CONNECTION FAILED</div>
          <div>${error.message}</div>
        `;
      }
    }
    
    function updateStatus(status) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      
      dot.className = 'status-dot';
      if (status === 'connected') {
        dot.classList.add('connected');
        text.textContent = 'Connected';
      } else if (status === 'error') {
        dot.classList.add('error');
        text.textContent = 'Error';
      } else {
        text.textContent = 'Connecting...';
      }
    }
    
    function reset() {
      state.token = null;
      state.apiKey = null;
      state.userId = null;
      state.connected = false;
      state.conversationId = null;
      state.plans = [];
      state.designerSession = null;
      state.exploreSessionId = null;
      state.explorePart = null;
      state.exploreMessages = [];
      state.exploreExtracted = null;
      state.defineGoalState = null;
      state.defineGoalGenerating = false;
      state.defineGoalStep = 0;
      state.pendingShieldWarning = null;
      
      updateStatus('disconnected');
      document.getElementById('chatMessages').innerHTML = `
        <div class="status-card error" id="connectionStatus">
          <div class="label">âœ• DISCONNECTED</div>
          <div>Click Connect to start</div>
        </div>
      `;
      document.getElementById('designerContent').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">âš”ï¸</div>
          <div class="empty-state-title">No Active Designer Session</div>
          <div class="empty-state-text">Start a design session to create a learning plan</div>
          <button class="btn btn-success" onclick="startDesigner()">Start Designer (TypeScript)</button>
        </div>
      `;
      renderExploreEmpty();
      renderDefineGoalEmpty();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API REQUEST
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function request(method, path, body = null) {
      const url = state.baseUrl + path;
      const headers = { 'Content-Type': 'application/json' };
      
      if (state.token) {
        headers['Authorization'] = 'Bearer ' + state.token;
      }
      if (state.apiKey) {
        headers['X-API-Key'] = state.apiKey;
      }
      
      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);
      
      const startTime = Date.now();
      
      try {
        const response = await fetch(url, options);
        const data = await response.json();
        const duration = Date.now() - startTime;
        
        logRequest(method, path, response.status, data, duration);
        
        if (!response.ok) {
          throw new Error(data.error?.message || data.message || 'Request failed');
        }
        
        return data.data !== undefined ? data.data : data;
      } catch (error) {
        logRequest(method, path, 0, { error: error.message }, Date.now() - startTime);
        throw error;
      }
    }
    
    function logRequest(method, path, status, data, duration) {
      const logsEl = document.getElementById('apiLogs');
      const time = new Date().toLocaleTimeString();
      const isSuccess = status >= 200 && status < 300;
      
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <div class="log-header">
          <span class="log-time">${time}</span>
          <span class="log-method ${method}">${method}</span>
          <span class="log-path">${path}</span>
          <span class="log-status ${isSuccess ? 'success' : 'error'}">${status || 'ERR'}</span>
          <span style="color: #666; font-size: 10px;">${duration}ms</span>
        </div>
        <div class="log-body">
          <pre>${JSON.stringify(data, null, 2).slice(0, 500)}</pre>
        </div>
      `;
      
      logsEl.insertBefore(entry, logsEl.firstChild);
    }
    
    function clearLogs() {
      document.getElementById('apiLogs').innerHTML = '';
    }
    
    async function callApi(method, path, body = null) {
      try {
        const result = await request(method, path, body);
        console.log('API Result:', result);
      } catch (error) {
        console.error('API Error:', error);
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CHAT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function sendChat() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;
      
      input.value = '';
      
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML += `<div class="message user">${message}</div>`;
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      try {
        // Build request payload
        const payload = { message };
        
        // If forcing new conversation, set flag (otherwise backend continues most recent)
        if (state.forceNewConversation) {
          payload.newConversation = true;
          state.forceNewConversation = false; // Reset after first message
        }
        
        const result = await request('POST', '/chat', payload);
        
        state.conversationId = result.conversationId;
        
        // Show conversation ID in first response
        if (result.isNewConversation) {
          chatMessages.innerHTML += `<div class="message system" style="font-size: 11px; padding: 6px 10px;">New conversation: ${result.conversationId}</div>`;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SHIELD BLOCKED â€” Handle warning or crisis
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (result.status === 'blocked' && result.shield) {
          const { shield } = result;
          
          if (shield.action === 'warn') {
            // MEDIUM signal â€” Show warning with confirm button
            state.pendingShieldWarning = {
              activationId: shield.activationId,
              warningMessage: shield.warningMessage,
              originalMessage: message,
            };
            
            chatMessages.innerHTML += `
              <div class="message shield-warning" style="background: linear-gradient(135deg, #1e3a5f 0%, #1a2e3a 100%); border: 1px solid #3b82f6; align-self: stretch;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span style="font-size: 20px;">ğŸ›¡ï¸</span>
                  <span style="color: #3b82f6; font-weight: 600;">Shield Warning</span>
                </div>
                <div style="color: #93c5fd; margin-bottom: 12px; line-height: 1.5;">${shield.warningMessage || 'This action may have significant consequences.'}</div>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-primary" onclick="confirmShieldWarning()">I Understand, Continue</button>
                  <button class="btn btn-secondary" onclick="dismissShieldWarning()">Cancel</button>
                </div>
              </div>
            `;
          } else if (shield.action === 'crisis') {
            // HIGH signal â€” Show crisis UI
            chatMessages.innerHTML += `
              <div class="message shield-crisis" style="background: linear-gradient(135deg, #3a1e1e 0%, #2e1a1a 100%); border: 1px solid #ef4444; align-self: stretch;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span style="font-size: 20px;">ğŸ†˜</span>
                  <span style="color: #ef4444; font-weight: 600;">Crisis Mode Activated</span>
                </div>
                <div style="color: #fca5a5; margin-bottom: 12px; line-height: 1.5;">
                  ${shield.riskAssessment?.riskExplanation || 'I want to make sure you\'re okay.'}
                </div>
                ${shield.riskAssessment?.alternatives ? `
                  <div style="color: #fca5a5; margin-bottom: 12px;">
                    <strong>Resources:</strong>
                    <ul style="margin: 8px 0 0 16px; padding: 0;">
                      ${shield.riskAssessment.alternatives.map(a => `<li>${a}</li>`).join('')}
                    </ul>
                  </div>
                ` : ''}
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-success" onclick="confirmSafe('${shield.sessionId}')">I'm Safe</button>
                </div>
              </div>
            `;
          }
          
          chatMessages.scrollTop = chatMessages.scrollHeight;
          return;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NORMAL RESPONSE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const stanceBadge = result.stance ? `<span class="stance-badge stance-${result.stance.toLowerCase()}">${result.stance}</span>` : '';
        chatMessages.innerHTML += `<div class="message assistant">${stanceBadge}${renderMarkdown(result.response)}</div>`;
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
      } catch (error) {
        chatMessages.innerHTML += `<div class="message system">Error: ${error.message}</div>`;
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SHIELD FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function confirmShieldWarning() {
      if (!state.pendingShieldWarning) {
        alert('No pending shield warning');
        return;
      }
      
      const chatMessages = document.getElementById('chatMessages');
      const { activationId, originalMessage } = state.pendingShieldWarning;
      
      chatMessages.innerHTML += `<div class="message system" style="background: #1e3a5f;">â³ Processing after confirmation...</div>`;
      
      try {
        const result = await request('POST', '/shield/confirm', { activationId });
        
        state.pendingShieldWarning = null;
        state.conversationId = result.conversationId;
        
        // Show the response
        const stanceBadge = result.stance ? `<span class="stance-badge stance-${result.stance.toLowerCase()}">${result.stance}</span>` : '';
        const confirmedBadge = result.shieldConfirmed ? `<span style="font-size: 10px; background: #22c55e33; color: #22c55e; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">SHIELD CONFIRMED</span>` : '';
        
        chatMessages.innerHTML += `<div class="message assistant">${stanceBadge}${confirmedBadge}${renderMarkdown(result.response)}</div>`;
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
      } catch (error) {
        chatMessages.innerHTML += `<div class="message system">Error confirming: ${error.message}</div>`;
      }
    }
    
    function dismissShieldWarning() {
      state.pendingShieldWarning = null;
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML += `<div class="message system" style="background: #333;">Action cancelled by user.</div>`;
    }
    
    async function confirmSafe(sessionId) {
      const chatMessages = document.getElementById('chatMessages');
      
      try {
        await request('POST', '/shield/safe', { sessionId });
        chatMessages.innerHTML += `<div class="message system" style="background: #1a2e1a; color: #22c55e;">âœ“ Crisis resolved. You can continue chatting.</div>`;
      } catch (error) {
        chatMessages.innerHTML += `<div class="message system">Error: ${error.message}</div>`;
      }
    }
    
    async function checkShieldStatus() {
      try {
        const result = await request('GET', '/shield/status');
        alert(`Shield Status:\n\nIn Crisis: ${result.inCrisis}\nSession ID: ${result.sessionId || 'none'}`);
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }
    
    function sendQuickMessage(msg) {
      document.getElementById('chatInput').value = msg;
      sendChat();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NEW CHAT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function newChat() {
      // Clear state
      state.conversationId = null;
      state.forceNewConversation = true;
      state.pendingShieldWarning = null;
      
      // Clear chat UI
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = `
        <div class="message system" style="background: #1a2e1a; border: 1px solid #22c55e33;">
          âœ“ Ready for new conversation
        </div>
      `;
      
      // Focus input
      document.getElementById('chatInput').focus();
      
      console.log('[HARNESS] New chat started');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EXPLORATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function startExplore() {
      if (!state.connected) {
        alert('Not connected! Click Connect first.');
        return;
      }
      
      const topic = document.getElementById('exploreTopic')?.value || '';
      
      try {
        const result = await request('POST', '/sword/explore/start', { topic });
        
        state.exploreSessionId = result.sessionId;
        state.explorePart = 'orient';
        state.exploreMessages = result.state?.messages || [];
        
        renderExploreOrient();
      } catch (error) {
        alert('Failed to start exploration: ' + error.message);
      }
    }
    
    function renderExploreEmpty() {
      document.getElementById('exploreContainer').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ”</div>
          <div class="empty-state-title">Start Exploring</div>
          <div class="empty-state-text">Have a conversation to discover what you want to learn</div>
          <button class="btn btn-success" onclick="startExplore()">Start Exploration</button>
          <div style="margin-top: 12px;">
            <input type="text" id="exploreTopic" placeholder="Optional: Enter a topic" style="background: #0f0f0f; border: 1px solid #333; padding: 8px 12px; border-radius: 6px; color: #fff; width: 200px;">
          </div>
        </div>
      `;
    }
    
    function renderExploreOrient() {
      const container = document.getElementById('exploreContainer');
      const messagesHtml = state.exploreMessages.map(m => `
        <div class="message ${m.role}">${renderMarkdown(m.content)}</div>
      `).join('');
      
      container.innerHTML = `
        <div class="explore-header">
          <div class="explore-phase">
            <span class="phase-badge orient">Part 1: Orient</span>
          </div>
          <div class="explore-title">Tell me about what you want to learn</div>
        </div>
        <div class="explore-chat">
          <div class="explore-messages" id="exploreMessages">${messagesHtml}</div>
          <div class="explore-input-area">
            <div class="explore-input-row">
              <input type="text" class="explore-input" id="exploreInput" placeholder="Describe your learning goal..." onkeypress="if(event.key==='Enter')sendExploreMessage()">
              <button class="btn btn-primary" onclick="sendExploreMessage()">Send</button>
            </div>
            <div class="explore-actions">
              <button class="btn btn-ghost btn-sm" onclick="cancelExplore()">Cancel</button>
              <button class="btn btn-success btn-sm" onclick="confirmOrient()" ${state.exploreMessages.length < 2 ? 'disabled' : ''}>I'm ready to continue â†’</button>
            </div>
          </div>
        </div>
      `;
      
      const messagesEl = document.getElementById('exploreMessages');
      if (messagesEl) messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    
    async function sendExploreMessage() {
      const input = document.getElementById('exploreInput');
      const message = input.value.trim();
      if (!message) return;
      
      input.value = '';
      
      state.exploreMessages.push({ role: 'user', content: message });
      renderExploreOrient();
      
      try {
        const result = await request('POST', '/sword/explore/chat', {
          sessionId: state.exploreSessionId,
          message
        });
        
        state.exploreMessages = result.state?.messages || state.exploreMessages;
        renderExploreOrient();
      } catch (error) {
        state.exploreMessages.push({ role: 'system', content: 'Error: ' + error.message });
        renderExploreOrient();
      }
    }
    
    async function confirmOrient() {
      try {
        const result = await request('POST', '/sword/explore/confirm', {
          sessionId: state.exploreSessionId
        });
        
        state.explorePart = 'clarify';
        state.exploreExtracted = result.extracted;
        state.exploreMissing = result.missing || [];
        state.exploreFieldSources = result.fieldSources || {};
        
        renderExploreClarify();
      } catch (error) {
        alert('Failed to continue: ' + error.message);
      }
    }
    
    const PREDEFINED_OPTIONS = {
      priorKnowledge: ['Complete beginner', 'Some basics', 'Intermediate', 'Advanced, looking to specialize'],
      context: ['Career development', 'Personal hobby', 'School/education', 'Starting a business', 'Other'],
      constraints: ['20 minutes per day', '30 minutes per day', '1 hour per day', 'Weekends only', 'Mobile-friendly only', 'Other']
    };

    function renderExploreClarify() {
      const container = document.getElementById('exploreContainer');
      const e = state.exploreExtracted || {};
      const sources = state.exploreFieldSources || {};
      const missing = state.exploreMissing || [];
      
      const fields = [
        { key: 'learningGoal', label: 'Learning Goal', icon: 'ğŸ¯', required: true, hasPresets: false },
        { key: 'priorKnowledge', label: 'Prior Knowledge', icon: 'ğŸ“š', required: true, hasPresets: true },
        { key: 'context', label: 'Context / Why', icon: 'ğŸ¨', required: false, hasPresets: true },
      ];
      
      let fieldsHtml = fields.map(field => {
        const value = e[field.key];
        const source = sources[field.key];
        const isEmpty = !value;
        const isEditing = state.editingField === field.key;
        const presets = field.hasPresets ? PREDEFINED_OPTIONS[field.key] || [] : [];
        
        if (isEditing) {
          return `
            <div class="clarify-field editing">
              <div class="clarify-field-header">
                <div class="clarify-field-label">
                  <span class="icon">${field.icon}</span>
                  ${field.label}
                  ${field.required ? '<span class="required">*</span>' : ''}
                </div>
              </div>
              <textarea class="clarify-field-input" id="fieldInput_${field.key}">${value || ''}</textarea>
              ${presets.length ? `
                <div class="clarify-presets">
                  ${presets.map(p => `
                    <button class="preset-btn" onclick="selectPreset('${field.key}', '${p.replace(/'/g, "\\'")}')">${p}</button>
                  `).join('')}
                </div>
              ` : ''}
              <div class="clarify-field-actions">
                <button class="btn btn-ghost btn-sm" onclick="cancelFieldEdit()">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="saveField('${field.key}')">Save</button>
              </div>
            </div>
          `;
        }
        
        return `
          <div class="clarify-field ${isEmpty ? 'empty' : 'filled'}" onclick="editField('${field.key}')">
            <div class="clarify-field-header">
              <div class="clarify-field-label">
                <span class="icon">${field.icon}</span>
                ${field.label}
                ${field.required ? '<span class="required">*</span>' : ''}
              </div>
              ${source ? `<span class="clarify-field-source ${source}">${source.replace('_', ' ')}</span>` : ''}
            </div>
            ${value ? `<div class="clarify-field-value">${value}</div>` : `<div class="clarify-field-empty">Tap to add...</div>`}
          </div>
        `;
      }).join('');
      
      const constraints = e.constraints || [];
      const constraintPresets = PREDEFINED_OPTIONS.constraints || [];
      const availablePresets = constraintPresets.filter(p => !constraints.includes(p));
      
      let constraintsHtml = `
        <div class="clarify-field ${constraints.length ? 'filled' : ''}">
          <div class="clarify-field-header">
            <div class="clarify-field-label">
              <span class="icon">â±ï¸</span>
              Constraints
            </div>
          </div>
          <div class="clarify-constraints">
            ${constraints.map((c, i) => `
              <span class="constraint-tag">
                ${c}
                <span class="constraint-remove" onclick="removeConstraint(${i})">âœ•</span>
              </span>
            `).join('')}
            <span class="add-constraint" onclick="addConstraint()">+ Custom</span>
          </div>
          ${availablePresets.length ? `
            <div class="clarify-presets constraint-presets">
              ${availablePresets.map(p => `
                <button class="preset-btn" onclick="addPresetConstraint('${p.replace(/'/g, "\\'")}')">${p}</button>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;
      
      const canContinue = !missing.includes('learningGoal') && !missing.includes('priorKnowledge');
      
      container.innerHTML = `
        <div class="explore-header">
          <div class="explore-phase">
            <span class="phase-badge clarify">Part 2: Clarify</span>
          </div>
          <div class="explore-title">Review and edit your learning profile</div>
        </div>
        <div class="clarify-form">
          ${fieldsHtml}
          ${constraintsHtml}
        </div>
        <div class="clarify-actions">
          <button class="btn btn-ghost" onclick="backToOrient()">â† Back</button>
          <button class="btn btn-success" onclick="completeExplore()" ${canContinue ? '' : 'disabled'}>
            Continue to Goal Definition â†’
          </button>
        </div>
      `;
    }
    
    function selectPreset(key, value) {
      const input = document.getElementById(`fieldInput_${key}`);
      if (input) {
        if (value === 'Other') {
          input.value = '';
          input.focus();
        } else {
          input.value = value;
        }
      }
    }
    
    async function addPresetConstraint(preset) {
      if (preset === 'Other') {
        addConstraint();
        return;
      }
      
      const constraints = [...(state.exploreExtracted?.constraints || []), preset];
      
      try {
        const result = await request('PATCH', '/sword/explore/constraints', {
          sessionId: state.exploreSessionId,
          constraints
        });
        
        state.exploreExtracted = result.extracted;
        renderExploreClarify();
      } catch (error) {
        alert('Failed to add constraint: ' + error.message);
      }
    }
    
    function editField(key) {
      if (state.editingField) return;
      state.editingField = key;
      renderExploreClarify();
      
      setTimeout(() => {
        const input = document.getElementById(`fieldInput_${key}`);
        if (input) input.focus();
      }, 50);
    }
    
    function cancelFieldEdit() {
      state.editingField = null;
      renderExploreClarify();
    }
    
    async function saveField(key) {
      const input = document.getElementById(`fieldInput_${key}`);
      const value = input.value.trim();
      
      try {
        const result = await request('PATCH', '/sword/explore/field', {
          sessionId: state.exploreSessionId,
          field: key,
          value
        });
        
        state.exploreExtracted = result.extracted;
        state.exploreMissing = result.missing || [];
        state.exploreFieldSources = result.fieldSources || {};
        state.editingField = null;
        
        renderExploreClarify();
      } catch (error) {
        alert('Failed to save: ' + error.message);
      }
    }
    
    async function addConstraint() {
      const constraint = prompt('Enter a constraint (e.g., "20 minutes per day"):');
      if (!constraint) return;
      
      const constraints = [...(state.exploreExtracted?.constraints || []), constraint];
      
      try {
        const result = await request('PATCH', '/sword/explore/constraints', {
          sessionId: state.exploreSessionId,
          constraints
        });
        
        state.exploreExtracted = result.extracted;
        renderExploreClarify();
      } catch (error) {
        alert('Failed to add constraint: ' + error.message);
      }
    }
    
    async function removeConstraint(index) {
      const constraints = [...(state.exploreExtracted?.constraints || [])];
      constraints.splice(index, 1);
      
      try {
        const result = await request('PATCH', '/sword/explore/constraints', {
          sessionId: state.exploreSessionId,
          constraints
        });
        
        state.exploreExtracted = result.extracted;
        renderExploreClarify();
      } catch (error) {
        alert('Failed to remove constraint: ' + error.message);
      }
    }
    
    async function backToOrient() {
      try {
        const result = await request('POST', '/sword/explore/back', {
          sessionId: state.exploreSessionId
        });
        
        state.explorePart = 'orient';
        state.exploreMessages = result.state.messages || [];
        
        renderExploreOrient();
      } catch (error) {
        alert('Failed to go back: ' + error.message);
      }
    }
    
    async function completeExplore() {
      try {
        const result = await request('POST', '/sword/explore/continue', {
          sessionId: state.exploreSessionId
        });
        
        // Keep session ID for define goal
        // Reset explore UI state
        state.explorePart = null;
        state.exploreMessages = [];
        state.exploreExtracted = null;
        
        // Switch to Define Goal tab
        switchTab('defineGoal');
        
      } catch (error) {
        alert('Failed to complete: ' + error.message);
      }
    }
    
    async function cancelExplore() {
      if (confirm('Cancel exploration? Your conversation will be lost.')) {
        try {
          await request('DELETE', '/sword/designer');
        } catch (error) {
          console.error('Failed to cancel session:', error);
        }
        
        state.explorePart = null;
        state.exploreMessages = [];
        state.exploreExtracted = null;
        state.exploreSessionId = null;
        renderExploreEmpty();
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DEFINE GOAL (NEW)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadDefineGoal() {
      if (!state.connected) return;
      
      try {
        const result = await request('GET', '/sword/goal');
        state.defineGoalState = result;
        state.defineGoalStep = result.capstone ? 4 : 0;
        renderDefineGoal();
      } catch (error) {
        console.log('No goal state yet:', error.message);
        renderDefineGoalEmpty();
      }
    }
    
    function renderDefineGoalEmpty() {
      document.getElementById('defineGoalContainer').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ¯</div>
          <div class="empty-state-title">Define Your Learning Goal</div>
          <div class="empty-state-text">Complete Exploration first, or generate a learning plan</div>
          <button class="btn btn-success" onclick="generateLearningPlan()">Generate Learning Plan</button>
          <div style="margin-top: 8px;">
            <button class="btn btn-ghost btn-sm" onclick="switchTab('explore')">â† Go to Explore</button>
          </div>
        </div>
      `;
    }
    
    async function generateLearningPlan() {
      state.defineGoalGenerating = true;
      state.defineGoalStep = 1;
      renderDefineGoalGenerating();
      
      try {
        // Call the generate endpoint
        const result = await request('POST', '/sword/goal/generate');
        
        state.defineGoalState = result;
        state.defineGoalStep = 4;
        state.defineGoalGenerating = false;
        
        renderDefineGoal();
      } catch (error) {
        state.defineGoalGenerating = false;
        state.defineGoalStep = 0;
        alert('Failed to generate: ' + error.message);
        renderDefineGoalEmpty();
      }
    }
    
    function renderDefineGoalGenerating() {
      const container = document.getElementById('defineGoalContainer');
      const steps = [
        { name: 'Capstone', desc: 'Defining your end goal' },
        { name: 'Subskills', desc: 'Breaking into learnable chunks' },
        { name: 'Routing', desc: 'Assigning teaching methods' },
      ];
      
      container.innerHTML = `
        <div class="define-goal-header">
          <div class="define-goal-title">Generating Learning Plan</div>
          <div class="define-goal-subtitle">Please wait...</div>
        </div>
        <div class="define-goal-content">
          <div class="generation-progress">
            ${steps.map((step, i) => {
              const stepNum = i + 1;
              let status = 'pending';
              if (stepNum < state.defineGoalStep) status = 'complete';
              else if (stepNum === state.defineGoalStep) status = 'active';
              
              return `
                <div class="generation-step">
                  <div class="step-indicator ${status}">${status === 'complete' ? 'âœ“' : stepNum}</div>
                  <div class="step-info">
                    <div class="step-title">Step ${stepNum}: ${step.name}</div>
                    <div class="step-subtitle">${step.desc}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }
    
    function renderDefineGoal() {
      const container = document.getElementById('defineGoalContainer');
      const data = state.defineGoalState;
      
      if (!data || !data.capstone) {
        renderDefineGoalEmpty();
        return;
      }
      
      const { capstone, subskillsWithRouting, summary } = data;
      
      // Capstone section
      const capstoneHtml = `
        <div class="capstone-section">
          <div class="capstone-header">
            <div class="capstone-title">${capstone.title || 'Learning Goal'}</div>
            <button class="btn btn-ghost btn-sm" onclick="regenerateCapstone()">â†» Regenerate</button>
          </div>
          <div class="capstone-statement">${capstone.capstoneStatement}</div>
          <div class="capstone-criteria">
            <div class="criteria-title">Success Criteria</div>
            <div class="criteria-list">
              ${(capstone.successCriteria || []).map(c => `
                <div class="criteria-item">${c}</div>
              `).join('')}
            </div>
          </div>
          <div class="capstone-meta">
            <span>â±ï¸ ${capstone.estimatedTime || 'Time TBD'}</span>
          </div>
        </div>
      `;
      
      // Subskills section
      const subskillsHtml = `
        <div class="subskills-section">
          <div class="subskills-header">
            <div class="subskills-title">Subskills</div>
            <div class="subskills-count">${subskillsWithRouting?.length || 0} skills</div>
          </div>
          ${(subskillsWithRouting || []).map(s => `
            <div class="subskill-card ${s.status === 'skip' ? 'skip' : ''} ${s.status === 'assess' ? 'assess' : ''}">
              <div class="subskill-header">
                <div class="subskill-title">${s.title}</div>
                <div class="subskill-badges">
                  <span class="subskill-type ${s.subskillType}">${s.subskillType}</span>
                  <span class="route-badge ${s.route}">${s.route}</span>
                </div>
              </div>
              <div class="subskill-desc">${s.description}</div>
              <div class="subskill-footer">
                <div class="subskill-route">
                  Complexity: ${'â˜…'.repeat(s.estimatedComplexity)}${'â˜†'.repeat(3 - s.estimatedComplexity)}
                </div>
                <div class="subskill-status">
                  <button class="status-btn learn ${s.status === 'learn' ? 'active' : ''}" onclick="setSubskillStatus('${s.id}', 'learn')">Learn</button>
                  <button class="status-btn skip ${s.status === 'skip' ? 'active' : ''}" onclick="setSubskillStatus('${s.id}', 'skip')">Skip</button>
                  <button class="status-btn assess ${s.status === 'assess' ? 'active' : ''}" onclick="setSubskillStatus('${s.id}', 'assess')">Assess</button>
                </div>
              </div>
              ${s.reason ? `<div class="reason-tooltip">${s.reason}</div>` : ''}
            </div>
          `).join('')}
        </div>
      `;
      
      // Summary section
      const summaryHtml = summary ? `
        <div class="summary-section">
          <div class="summary-title">ğŸ“Š Plan Summary</div>
          <div class="summary-grid">
            <div class="summary-stat">
              <div class="summary-stat-value">${summary.totalSubskills || 0}</div>
              <div class="summary-stat-label">Total Skills</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-value">${summary.totalToLearn || 0}</div>
              <div class="summary-stat-label">To Learn</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-value">${summary.totalToSkip || 0}</div>
              <div class="summary-stat-label">To Skip</div>
            </div>
          </div>
        </div>
      ` : '';
      
      container.innerHTML = `
        <div class="define-goal-header">
          <div class="define-goal-title">ğŸ¯ Learning Plan</div>
          <div class="define-goal-subtitle">Review and customize your plan</div>
        </div>
        <div class="define-goal-content">
          ${summaryHtml}
          ${capstoneHtml}
          ${subskillsHtml}
        </div>
        <div class="define-goal-actions">
          <button class="btn btn-ghost" onclick="regenerateLearningPlan()">â†» Regenerate All</button>
          <button class="btn btn-success" onclick="goToReview()">Continue to Review â†’</button>
        </div>
      `;
    }
    
    async function setSubskillStatus(subskillId, status) {
      try {
        const result = await request('PATCH', `/sword/goal/routing/${subskillId}/status`, { status });
        state.defineGoalState = result;
        renderDefineGoal();
      } catch (error) {
        alert('Failed to update status: ' + error.message);
      }
    }
    
    async function regenerateCapstone() {
      if (!confirm('Regenerate capstone? This will also regenerate subskills and routing.')) return;
      
      state.defineGoalStep = 1;
      renderDefineGoalGenerating();
      
      try {
        const result = await request('POST', '/sword/goal/capstone/regenerate');
        state.defineGoalState = result;
        state.defineGoalStep = 4;
        renderDefineGoal();
      } catch (error) {
        alert('Failed to regenerate: ' + error.message);
        renderDefineGoal();
      }
    }
    
    async function regenerateLearningPlan() {
      if (!confirm('Regenerate entire learning plan?')) return;
      await generateLearningPlan();
    }
    
    // Go to Review (replaces confirmDefineGoal)
    function goToReview() {
      switchTab('review');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REVIEW
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadReview() {
      if (!state.connected) return;
      
      const container = document.getElementById('reviewContainer');
      container.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <span>Loading review...</span>
        </div>
      `;
      
      try {
        const review = await request('GET', '/sword/review');
        state.reviewData = review;
        renderReview();
      } catch (error) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <div class="empty-state-title">Review Your Plan</div>
            <div class="empty-state-text">Complete Define Goal first to review your plan</div>
            <button class="btn btn-ghost" onclick="switchTab('defineGoal')">â† Go to Define Goal</button>
          </div>
        `;
      }
    }
    
    function renderReview() {
      const container = document.getElementById('reviewContainer');
      const r = state.reviewData;
      
      if (!r || !r.capstone) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <div class="empty-state-title">No Data to Review</div>
            <div class="empty-state-text">Complete Define Goal first</div>
            <button class="btn btn-ghost" onclick="switchTab('defineGoal')">â† Go to Define Goal</button>
          </div>
        `;
        return;
      }
      
      const capstoneHtml = `
        <div class="status-card" style="margin-bottom: 16px;">
          <div class="label">ğŸ“ CAPSTONE</div>
          <div style="font-size: 16px; font-weight: 600; margin: 8px 0;">${r.capstone.title}</div>
          <div style="color: #888; font-style: italic; margin-bottom: 8px;">${r.capstone.statement}</div>
          <div class="label" style="margin-top: 12px;">Success Criteria:</div>
          <ul style="margin: 4px 0 0 16px; color: #888;">
            ${(r.capstone.successCriteria || []).map(c => `<li>${c}</li>`).join('')}
          </ul>
        </div>
      `;
      
      const statsHtml = `
        <div class="status-card" style="margin-bottom: 16px;">
          <div class="label">ğŸ“Š PLAN STATS</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
            <div><strong>${r.stats?.totalSubskills || 0}</strong> Total Skills</div>
            <div><strong>${r.stats?.toLearn || 0}</strong> To Learn</div>
            <div><strong>${r.stats?.toSkip || 0}</strong> To Skip</div>
            <div><strong>${r.stats?.toAssess || 0}</strong> To Assess</div>
          </div>
          <div style="margin-top: 12px; color: #22c55e;">
            â±ï¸ ${r.capstone?.estimatedTime || 'Time TBD'}
          </div>
        </div>
      `;
      
      const subskillsHtml = `
        <div class="status-card">
          <div class="label">ğŸ“š SUBSKILLS (${r.subskills?.length || 0})</div>
          <div style="max-height: 300px; overflow-y: auto; margin-top: 8px;">
            ${(r.subskills || []).map((s, i) => {
              const sessionDisplay = s.status === 'skip' 
                ? '<span style="color: #666; font-size: 11px; margin-left: 8px;">skipped</span>'
                : `<span style="color: #22c55e; font-size: 11px; margin-left: 8px;">${s.estimatedSessions || 1} session${(s.estimatedSessions || 1) > 1 ? 's' : ''}</span>`;
              return `
              <div style="padding: 8px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; ${s.status === 'skip' ? 'opacity: 0.5;' : ''}">
                <div>
                  <span style="color: #666; margin-right: 8px;">${i + 1}.</span>
                  <strong>${s.title}</strong>
                  <span style="color: #666; font-size: 11px; margin-left: 8px;">${s.route}</span>
                  ${sessionDisplay}
                </div>
                <span class="status-badge ${s.status === 'learn' ? 'success' : s.status === 'skip' ? 'secondary' : 'warning'}">
                  ${s.status}
                </span>
              </div>
            `}).join('')}
          </div>
        </div>
      `;
      
      container.innerHTML = `
        <div style="padding: 16px;">
          <div style="margin-bottom: 16px;">
            <span class="phase-badge" style="background: #8b5cf6;">ğŸ“‹ Review</span>
            <span style="color: #888; margin-left: 8px;">Confirm your plan before creating</span>
          </div>
          ${statsHtml}
          ${capstoneHtml}
          ${subskillsHtml}
          <div style="display: flex; gap: 8px; margin-top: 16px;">
            <button class="btn btn-ghost" onclick="switchTab('defineGoal')">â† Back to Edit</button>
            <button class="btn btn-success" onclick="createPlan()">âœ“ Create Plan</button>
          </div>
        </div>
      `;
    }
    
    async function createPlan() {
      if (!confirm('Create this learning plan?')) return;
      
      const container = document.getElementById('reviewContainer');
      container.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <span>Creating plan...</span>
        </div>
      `;
      
      try {
        const result = await request('POST', '/sword/review/confirm');
        alert('Plan created successfully!\n\n' + (result.plan?.title || 'Your plan is ready'));
        state.reviewData = null;
        state.defineGoalState = null;
        switchTab('plans');
        loadPlans();
      } catch (error) {
        alert('Failed to create plan: ' + error.message);
        renderReview();
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DESIGNER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadDesigner() {
      if (!state.connected) return;
      
      try {
        const session = await request('GET', '/sword/designer');
        state.designerSession = session;
        renderDesigner();
      } catch (error) {
        console.error('Failed to load designer:', error);
      }
    }
    
    function renderDesigner() {
      const container = document.getElementById('designerContent');
      const session = state.designerSession;
      
      if (!session) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âš”ï¸</div>
            <div class="empty-state-title">No Active Designer Session</div>
            <div class="empty-state-text">Start a design session to create a learning plan</div>
            <button class="btn btn-success" onclick="startDesigner()">Start Designer (TypeScript)</button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div class="status-card">
          <div class="label">ACTIVE SESSION</div>
          <div><strong>Phase:</strong> ${session.visiblePhase} (${session.internalPhase})</div>
          <div><strong>Topic:</strong> ${session.explorationData?.learningGoal || 'N/A'}</div>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px;">
          <button class="btn btn-primary btn-sm" onclick="switchTab('explore')">Explore</button>
          <button class="btn btn-primary btn-sm" onclick="switchTab('defineGoal')">Define Goal</button>
          <button class="btn btn-primary btn-sm" onclick="switchTab('review')">Review</button>
          <button class="btn btn-success btn-sm" onclick="createPlan()">Create Plan</button>
          <button class="btn btn-danger btn-sm" onclick="cancelDesigner()">Cancel</button>
        </div>
      `;
    }
    
    async function startDesigner() {
      if (!state.connected) {
        alert('Not connected! Click Connect first.');
        return;
      }
      
      try {
        const session = await request('POST', '/sword/designer/start', { topic: 'TypeScript' });
        state.designerSession = session;
        renderDesigner();
      } catch (error) {
        alert('Failed to start designer: ' + error.message);
      }
    }
    
    async function runDesignerPhase(phase) {
      try {
        const endpoint = `/sword/designer/${phase}`;
        const body = phase === 'goal' ? {
          topic: 'TypeScript',
          goal: 'Build type-safe applications',
          context: 'Developer learning',
          difficulty: 'intermediate',
          dailyMinutes: 20,
          weeklyCadence: 5
        } : {};
        
        const session = await request('POST', endpoint, body);
        state.designerSession = session;
        renderDesigner();
      } catch (error) {
        alert(`Failed to run ${phase}: ` + error.message);
      }
    }
    
    async function finalizeDesigner() {
      try {
        const plan = await request('POST', '/sword/designer/finalize');
        alert('Plan created: ' + plan.title);
        state.designerSession = null;
        renderDesigner();
        loadPlans();
      } catch (error) {
        alert('Failed to finalize: ' + error.message);
      }
    }
    
    async function cancelDesigner() {
      if (!confirm('Cancel this design session?')) return;
      
      try {
        await request('DELETE', '/sword/designer');
        state.designerSession = null;
        state.defineGoalState = null;
        renderDesigner();
        renderDefineGoalEmpty();
      } catch (error) {
        alert('Failed to cancel: ' + error.message);
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PLANS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadPlans() {
      if (!state.connected) return;
      
      try {
        const plans = await request('GET', '/sword/plans');
        state.plans = plans || [];
        renderPlans();
      } catch (error) {
        console.error('Failed to load plans:', error);
        state.plans = [];
        renderPlans();
      }
    }
    
    function loadPlansButton() {
      switchTab('plans');
    }
    
    function renderPlans() {
      const container = document.getElementById('plansContent');
      
      if (!state.plans.length) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“š</div>
            <div class="empty-state-title">No Plans Yet</div>
            <div class="empty-state-text">Create a learning plan using the Designer</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div style="display: flex; justify-content: flex-end; margin-bottom: 12px;">
          <button class="btn btn-ghost btn-sm" onclick="deleteAllPlans()" style="color: #ef4444;">
            ğŸ—‘ï¸ Delete All Plans
          </button>
        </div>
        <div class="plans-grid">
          ${state.plans.map(plan => `
            <div class="plan-card ${plan.status === 'active' ? 'active' : ''}">
              <div class="plan-header">
                <div class="plan-title">${plan.title}</div>
                <span class="plan-status ${plan.status}">${plan.status}</span>
              </div>
              ${plan.capstoneStatement ? `<div class="plan-capstone">${plan.capstoneStatement}</div>` : ''}
              <div class="plan-meta">
                <span>ğŸ“š ${plan.totalSubskills || 0} skills</span>
                <span>ğŸ“… ${plan.estimatedSessions || 0} sessions</span>
                <span>â±ï¸ ${plan.estimatedTimeDisplay || `~${plan.estimatedWeeks || 0} weeks`}</span>
              </div>
              <div class="plan-progress">
                <div class="plan-progress-bar" style="width: ${(plan.progress || 0) * 100}%"></div>
              </div>
              <div class="plan-actions">
                ${plan.status !== 'active' ? `<button class="btn btn-success btn-sm" onclick="activatePlan('${plan.id}')">Activate</button>` : ''}
                <button class="btn btn-secondary btn-sm" onclick="viewPlanSubskills('${plan.id}')">View Subskills</button>
                <button class="btn btn-ghost btn-sm" onclick="deletePlan('${plan.id}')" style="color: #ef4444;">Delete</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    async function activatePlan(planId) {
      try {
        await request('POST', `/sword/plans/${planId}/activate`);
        loadPlans();
        loadToday();
      } catch (error) {
        alert('Failed to activate: ' + error.message);
      }
    }
    
    async function viewPlanSubskills(planId) {
      try {
        const subskills = await request('GET', `/sword/plans/${planId}/subskills`);
        const display = subskills.map((s, i) => {
          const sessionInfo = s.status === 'skipped' ? 'skipped' : `${s.estimatedSessions || 1} sessions`;
          return `${i+1}. ${s.title} (${s.route}) - ${sessionInfo} - ${s.status}`;
        }).join('\n');
        alert('Subskills:\n' + display);
      } catch (error) {
        alert('Failed to load subskills: ' + error.message);
      }
    }
    
    async function deletePlan(planId) {
      if (!confirm('Are you sure you want to delete this plan? This cannot be undone.')) {
        return;
      }
      
      try {
        await request('DELETE', `/sword/plans/${planId}`);
        loadPlans();
        loadToday();
      } catch (error) {
        alert('Failed to delete plan: ' + error.message);
      }
    }
    
    async function deleteAllPlans() {
      const planCount = state.plans.length;
      if (!confirm(`Are you sure you want to delete ALL ${planCount} plan(s)? This cannot be undone.`)) {
        return;
      }
      
      try {
        const result = await request('DELETE', '/sword/plans?confirm=true');
        alert(result.message || 'All plans deleted');
        loadPlans();
        loadToday();
      } catch (error) {
        alert('Failed to delete plans: ' + error.message);
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TODAY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadToday() {
      if (!state.connected) return;
      
      try {
        const today = await request('GET', '/sword/today');
        renderToday(today);
      } catch (error) {
        console.error('Failed to load today:', error);
        renderToday(null);
      }
    }
    
    function renderToday(data) {
      const container = document.getElementById('todayContent');
      
      if (!data || !data.plan) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“…</div>
            <div class="empty-state-title">No Active Learning</div>
            <div class="empty-state-text">Activate a plan to see today's learning content</div>
          </div>
        `;
        return;
      }
      
      const node = data.currentNode || {};
      const plan = data.plan || {};
      
      container.innerHTML = `
        <div class="today-card">
          <div class="today-header">Today's Learning</div>
          <div class="today-title">${plan.title || 'Untitled'}</div>
          <div class="today-meta">
            <span>ğŸ“š Node ${data.nodeIndex || 0}/${plan.totalNodes || 0}</span>
            <span>ğŸ“… Session ${data.sessionIndex || 1}/${node.estimatedSessions || 1}</span>
          </div>
          <div class="today-node">
            <div class="today-node-title">${node.title || 'No current node'}</div>
            <div class="today-node-objective">${node.objective || ''}</div>
            <span class="route-badge ${(node.route || '').toLowerCase()}">${node.route || 'N/A'}</span>
          </div>
        </div>
      `;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LESSON RUNNER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadRunner() {
      if (!state.connected) {
        renderRunnerEmpty('Connect first to use the Lesson Runner');
        return;
      }
      
      try {
        // Load today state and stats
        const [today, stats] = await Promise.all([
          request('GET', '/sword/today').catch(() => null),
          request('GET', '/sword/stats').catch(() => null),
        ]);
        
        state.runnerToday = today;
        state.runnerStats = stats;
        
        // If we have a plan, load subskills
        if (today?.plan?.id) {
          const subskills = await request('GET', `/sword/runner/subskills/${today.plan.id}`).catch(() => []);
          state.runnerSubskills = subskills || [];
        }
        
        renderRunner();
      } catch (error) {
        console.error('Failed to load runner:', error);
        renderRunnerEmpty('Failed to load runner: ' + error.message);
      }
    }
    
    function renderRunnerEmpty(message) {
      document.getElementById('runnerContent').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸƒ</div>
          <div class="empty-state-title">Lesson Runner</div>
          <div class="empty-state-text">${message}</div>
        </div>
      `;
    }
    
    function renderRunner() {
      const container = document.getElementById('runnerContent');
      const today = state.runnerToday;
      const stats = state.runnerStats;
      
      if (!today?.plan) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸƒ</div>
            <div class="empty-state-title">No Active Plan</div>
            <div class="empty-state-text">Activate a plan in the Plans tab to use the Lesson Runner</div>
            <button class="btn btn-primary" onclick="switchTab('plans')">Go to Plans</button>
          </div>
          ${stats ? renderRunnerStats(stats) : ''}
        `;
        return;
      }
      
      const subskill = today.currentSubskill || {};
      const needsRefresh = today.needsRefresh;
      
      container.innerHTML = `
        <div class="runner-section">
          <div class="runner-header">
            <h3>ğŸ“š Current Plan: ${today.plan.title}</h3>
            <span class="status-badge success">${today.plan.status}</span>
          </div>
          <div class="runner-progress">
            <div class="runner-progress-bar" style="width: ${(today.overallProgress || 0) * 100}%"></div>
          </div>
          <div class="runner-meta">
            <span>Subskills: ${today.subskillsCompleted}/${today.totalSubskills}</span>
            <span>Session: ${today.sessionNumber}/${today.totalSessions}</span>
            ${today.isKnowledgeCheckDay ? '<span style="color: #f59e0b;">âš¡ Knowledge Check Day</span>' : ''}
          </div>
        </div>
        
        ${needsRefresh ? `
          <div class="runner-section" style="border-color: #f59e0b; background: #2e2a1a;">
            <h4 style="color: #f59e0b;">âš ï¸ Refresh Needed (${today.refreshGapDays} day gap)</h4>
            <p style="color: #888; margin: 8px 0;">You haven't practiced in a while. Consider a quick review.</p>
            <div class="runner-actions">
              <button class="btn btn-primary btn-sm" onclick="getRefreshContent('${subskill.id}')">Get Refresh Content</button>
              <button class="btn btn-secondary btn-sm" onclick="skipRefresh('${subskill.id}')">Skip Refresh</button>
            </div>
          </div>
        ` : ''}
        
        <div class="runner-section">
          <h4>ğŸ¯ Current Subskill</h4>
          <div class="subskill-card" style="margin-top: 12px;">
            <div class="subskill-header">
              <div class="subskill-title">${subskill.title || 'None'}</div>
              <div class="subskill-badges">
                <span class="route-badge ${(subskill.route || '').toLowerCase()}">${subskill.route || 'N/A'}</span>
                <span class="status-badge ${subskill.status === 'active' ? 'success' : 'secondary'}">${subskill.status || 'N/A'}</span>
              </div>
            </div>
            ${subskill.description ? `<div class="subskill-desc">${subskill.description}</div>` : ''}
            <div class="runner-actions">
              <button class="btn btn-success btn-sm" onclick="startSubskill('${subskill.id}')">Start Subskill</button>
              <button class="btn btn-primary btn-sm" onclick="startSession('${subskill.id}')">Start Session</button>
              ${today.isKnowledgeCheckDay ? `<button class="btn btn-warning btn-sm" onclick="getKnowledgeCheck('${subskill.id}')">Get Knowledge Check</button>` : ''}
              <button class="btn btn-secondary btn-sm" onclick="getSubskillProgress('${subskill.id}')">View Progress</button>
            </div>
          </div>
        </div>
        
        <div class="runner-section">
          <h4>ğŸ“‹ All Subskills (${state.runnerSubskills.length})</h4>
          <div class="runner-subskills-list">
            ${state.runnerSubskills.map((s, i) => `
              <div class="runner-subskill-item ${s.status}">
                <span class="runner-subskill-num">${i + 1}</span>
                <span class="runner-subskill-title">${s.title}</span>
                <span class="route-badge ${(s.route || '').toLowerCase()}">${s.route}</span>
                <span class="status-badge ${s.status === 'mastered' ? 'success' : s.status === 'active' ? 'warning' : 'secondary'}">${s.status}</span>
                <button class="btn btn-ghost btn-sm" onclick="startSubskill('${s.id}')">â†’</button>
              </div>
            `).join('')}
          </div>
        </div>
        
        ${state.runnerDailyLesson ? renderDailyLesson(state.runnerDailyLesson) : ''}
        ${state.runnerKnowledgeCheck ? renderKnowledgeCheck(state.runnerKnowledgeCheck) : ''}
        
        ${stats ? renderRunnerStats(stats) : ''}
        
        <div class="runner-section">
          <h4>ğŸ”§ Quick Actions</h4>
          <div class="runner-actions" style="flex-wrap: wrap;">
            <button class="btn btn-secondary btn-sm" onclick="callApi('GET', '/sword/today')">GET Today</button>
            <button class="btn btn-secondary btn-sm" onclick="callApi('GET', '/sword/stats')">GET Stats</button>
            <button class="btn btn-secondary btn-sm" onclick="refreshRunner()">Refresh Runner</button>
          </div>
        </div>
      `;
    }
    
    function renderRunnerStats(stats) {
      return `
        <div class="runner-section">
          <h4>ğŸ“Š Learning Stats</h4>
          <div class="runner-stats-grid">
            <div class="runner-stat">
              <div class="runner-stat-value">${stats.totalPlans || 0}</div>
              <div class="runner-stat-label">Total Plans</div>
            </div>
            <div class="runner-stat">
              <div class="runner-stat-value">${stats.subskillsCompleted || 0}/${stats.subskillsTotal || 0}</div>
              <div class="runner-stat-label">Subskills</div>
            </div>
            <div class="runner-stat">
              <div class="runner-stat-value">${stats.sessionsCompletedTotal || 0}</div>
              <div class="runner-stat-label">Sessions Done</div>
            </div>
            <div class="runner-stat">
              <div class="runner-stat-value">${stats.sessionsCompletedThisWeek || 0}</div>
              <div class="runner-stat-label">This Week</div>
            </div>
            <div class="runner-stat">
              <div class="runner-stat-value">${stats.currentStreak || 0}</div>
              <div class="runner-stat-label">Streak</div>
            </div>
            <div class="runner-stat">
              <div class="runner-stat-value">${stats.averageScore || 0}%</div>
              <div class="runner-stat-label">Avg Score</div>
            </div>
            <div class="runner-stat">
              <div class="runner-stat-value">${stats.knowledgeChecksPassed || 0}</div>
              <div class="runner-stat-label">Checks Passed</div>
            </div>
            <div class="runner-stat">
              <div class="runner-stat-value">${Math.round((stats.totalMinutesLearned || 0) / 60)}h</div>
              <div class="runner-stat-label">Total Time</div>
            </div>
          </div>
        </div>
      `;
    }
    
    // Simple markdown parser for activity content
    function parseMarkdown(text) {
      if (!text) return '';
      return text
        // Code blocks (must come before inline code)
        .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre style="background: #1a1a1a; padding: 12px; border-radius: 6px; overflow-x: auto; margin: 8px 0;"><code>$2</code></pre>')
        // Inline code
        .replace(/`([^`]+)`/g, '<code style="background: #333; padding: 2px 6px; border-radius: 3px; font-family: monospace;">$1</code>')
        // Bold
        .replace(/\*\*([^*]+)\*\*/g, '<strong style="color: #fff;">$1</strong>')
        // Italic
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        // Simple tables (convert to readable format)
        .replace(/\|([^|]+)\|([^|]+)\|([^|]+)\|([^|]+)\|/g, (match, c1, c2, c3, c4) => {
          // Skip separator rows
          if (c1.includes('---')) return '';
          return `<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 4px 0; border-bottom: 1px solid #333;"><span>${c1.trim()}</span><span>${c2.trim()}</span><span>${c3.trim()}</span><span>${c4.trim()}</span></div>`;
        })
        .replace(/\|([^|]+)\|([^|]+)\|([^|]+)\|/g, (match, c1, c2, c3) => {
          if (c1.includes('---')) return '';
          return `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 4px 0; border-bottom: 1px solid #333;"><span>${c1.trim()}</span><span>${c2.trim()}</span><span>${c3.trim()}</span></div>`;
        })
        // Line breaks
        .replace(/\n/g, '<br>');
    }
    
    function getActivityColor(type) {
      const colors = {
        read: '#3b82f6',    // blue
        watch: '#ef4444',   // red
        exercise: '#22c55e', // green
        practice: '#f59e0b', // amber
        build: '#8b5cf6',   // purple
        quiz: '#ec4899',    // pink
      };
      return colors[type] || '#666';
    }

    function renderActivityContent(activity) {
      switch (activity.type) {
        case 'read':
          return `
            ${activity.explanation ? `
              <div style="color: #ccc; line-height: 1.6; margin-bottom: 12px;">
                ${parseMarkdown(activity.explanation)}
              </div>
            ` : ''}
            ${activity.article ? `
              <a href="${activity.article.url}" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; color: #3b82f6; text-decoration: none; padding: 8px 12px; background: #1e3a5f; border-radius: 6px;">
                ğŸ“„ ${activity.article.title || 'Read Article'}
                <span style="font-size: 11px; color: #888;">â†—</span>
              </a>
            ` : ''}
          `;
        
        case 'watch':
          return `
            ${activity.video ? `
              <div style="background: #2a1a1a; border-radius: 8px; margin-bottom: 12px; overflow: hidden;">
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px;">
                  ${activity.video.thumbnailUrl ? `
                    <img src="${activity.video.thumbnailUrl}" alt="" style="width: 120px; height: 68px; object-fit: cover; border-radius: 4px;">
                  ` : `
                    <div style="width: 120px; height: 68px; background: #333; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 24px;">â–¶ï¸</div>
                  `}
                  <div style="flex: 1;">
                    <div style="font-weight: 500; margin-bottom: 4px; color: #fff;">${activity.video.title}</div>
                    ${activity.video.channel ? `<div style="font-size: 12px; color: #888;">${activity.video.channel}</div>` : ''}
                    ${activity.video.duration ? `<div style="font-size: 12px; color: #888;">Duration: ${activity.video.duration}</div>` : ''}
                    ${activity.video.viewCount ? `<div style="font-size: 12px; color: #888;">${activity.video.viewCount.toLocaleString()} views</div>` : ''}
                  </div>
                </div>
                <a href="${activity.video.url}" target="_blank" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px; background: #ef4444; color: #fff; text-decoration: none; font-weight: 500; font-size: 14px;">
                  â–¶ Open in YouTube
                </a>
              </div>
            ` : ''}
            ${activity.focusPoints?.length ? `
              <div style="margin-top: 8px;">
                <div style="font-size: 12px; color: #888; margin-bottom: 4px;">Focus on:</div>
                <ul style="margin: 0; padding-left: 20px; color: #ccc;">
                  ${activity.focusPoints.map(fp => `<li style="margin: 4px 0;">${fp}</li>`).join('')}
                </ul>
              </div>
            ` : ''}
          `;
        
        case 'exercise':
          return `
            ${activity.prompt ? `
              <div style="background: #1a2e1a; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                <div style="font-size: 12px; color: #22c55e; margin-bottom: 4px;">Exercise:</div>
                <div style="color: #ccc;">${parseMarkdown(activity.prompt)}</div>
              </div>
            ` : ''}
            ${activity.expectedOutcome ? `
              <div style="font-size: 12px; color: #888; margin-bottom: 8px;">
                <strong>Expected outcome:</strong> ${parseMarkdown(activity.expectedOutcome)}
              </div>
            ` : ''}
            ${activity.hints?.length ? `
              <details style="margin-top: 8px;">
                <summary style="cursor: pointer; color: #f59e0b; font-size: 13px;">ğŸ’¡ Show Hints</summary>
                <ul style="margin: 8px 0 0 20px; color: #ccc;">
                  ${activity.hints.map(h => `<li style="margin: 4px 0;">${parseMarkdown(h)}</li>`).join('')}
                </ul>
              </details>
            ` : ''}
            ${activity.solution ? `
              <details style="margin-top: 8px;">
                <summary style="cursor: pointer; color: #3b82f6; font-size: 13px;">âœ… Show Solution</summary>
                <div style="margin-top: 8px; padding: 12px; background: #1a1a2e; border-radius: 6px; color: #ccc;">
                  ${parseMarkdown(activity.solution)}
                </div>
              </details>
            ` : ''}
          `;
        
        case 'practice':
          return `
            ${activity.steps?.length ? `
              <div style="margin-bottom: 12px;">
                <div style="font-size: 12px; color: #f59e0b; margin-bottom: 8px;">Steps:</div>
                <ol style="margin: 0; padding-left: 20px; color: #ccc;">
                  ${activity.steps.map(s => `<li style="margin: 6px 0;">${s}</li>`).join('')}
                </ol>
              </div>
            ` : ''}
            ${activity.checklist?.length ? `
              <div style="margin-bottom: 12px;">
                <div style="font-size: 12px; color: #888; margin-bottom: 8px;">Checklist:</div>
                ${activity.checklist.map(item => `
                  <label style="display: flex; align-items: center; gap: 8px; color: #ccc; margin: 4px 0; cursor: pointer;">
                    <input type="checkbox" style="width: 16px; height: 16px;">
                    <span>${item}</span>
                  </label>
                `).join('')}
              </div>
            ` : ''}
            ${activity.tips?.length ? `
              <div style="background: #2e2a1a; padding: 10px; border-radius: 6px;">
                <div style="font-size: 12px; color: #f59e0b; margin-bottom: 4px;">ğŸ’¡ Tips:</div>
                <ul style="margin: 0; padding-left: 20px; color: #ccc; font-size: 13px;">
                  ${activity.tips.map(t => `<li style="margin: 4px 0;">${t}</li>`).join('')}
                </ul>
              </div>
            ` : ''}
          `;
        
        case 'build':
          return `
            ${activity.objective ? `
              <div style="background: #1a1a2e; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                <div style="font-size: 12px; color: #8b5cf6; margin-bottom: 4px;">Objective:</div>
                <div style="color: #ccc;">${parseMarkdown(activity.objective)}</div>
              </div>
            ` : ''}
            ${activity.requirements?.length ? `
              <div style="margin-bottom: 12px;">
                <div style="font-size: 12px; color: #888; margin-bottom: 8px;">Requirements:</div>
                <ul style="margin: 0; padding-left: 20px; color: #ccc;">
                  ${activity.requirements.map(r => `<li style="margin: 4px 0;">${parseMarkdown(r)}</li>`).join('')}
                </ul>
              </div>
            ` : ''}
            ${activity.guidance ? `
              <details style="margin-top: 8px;">
                <summary style="cursor: pointer; color: #8b5cf6; font-size: 13px;">ğŸ”§ Implementation Guidance</summary>
                <div style="margin-top: 8px; padding: 12px; background: #1a1a1a; border-radius: 6px; color: #ccc; line-height: 1.5;">
                  ${parseMarkdown(typeof activity.guidance === 'string' ? activity.guidance : activity.guidance.join('\n'))}
                </div>
              </details>
            ` : ''}
          `;
        
        case 'quiz':
          return `
            ${activity.questions?.length ? `
              <div class="activity-quiz">
                ${activity.questions.map((q, i) => `
                  <div style="background: #1a1a2e; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                    <div style="font-weight: 500; color: #fff; margin-bottom: 12px;">${i + 1}. ${parseMarkdown(q.question)}</div>
                    ${q.options?.length ? `
                      <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${q.options.map(opt => `
                          <label style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: #262626; border-radius: 4px; cursor: pointer; color: #ccc;">
                            <input type="radio" name="activity_q_${q.id || i}" value="${opt}" style="width: 16px; height: 16px;">
                            <span>${parseMarkdown(opt)}</span>
                          </label>
                        `).join('')}
                      </div>
                    ` : ''}
                    ${q.correctAnswer ? `
                      <details style="margin-top: 12px;">
                        <summary style="cursor: pointer; color: #22c55e; font-size: 13px;">Show Answer</summary>
                        <div style="margin-top: 8px; padding: 8px 12px; background: #1a2e1a; border-radius: 4px;">
                          <div style="color: #22c55e; font-weight: 500;">${parseMarkdown(q.correctAnswer)}</div>
                          ${q.explanation ? `<div style="color: #888; font-size: 13px; margin-top: 4px;">${parseMarkdown(q.explanation)}</div>` : ''}
                        </div>
                      </details>
                    ` : ''}
                  </div>
                `).join('')}
              </div>
            ` : ''}
          `;
        
        default:
          return `<div style="color: #888; font-size: 13px;">No additional content</div>`;
      }
    }

    function renderDailyLesson(lesson) {
      return `
        <div class="runner-section" style="border-color: #22c55e; background: #1a2e1a;">
          <h4>ğŸ“– Current Session (${lesson.sessionNumber})</h4>
          <div style="color: #22c55e; margin-bottom: 8px;">${lesson.sessionGoal || 'No goal set'}</div>
          
          ${lesson.content ? `
            <div class="lesson-content">
              ${lesson.content.map(section => `
                <div class="lesson-section">
                  <h5>${section.title}</h5>
                  <p>${section.content}</p>
                  ${section.bulletPoints?.length ? `
                    <ul>${section.bulletPoints.map(bp => `<li>${bp}</li>`).join('')}</ul>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          ${lesson.activities ? `
            <div class="lesson-activities">
              <h5>Activities</h5>
              ${lesson.activities.map(a => `
                <div class="lesson-activity ${a.completed ? 'completed' : ''}" style="margin-bottom: 16px; padding: 12px; background: #1a1a1a; border-radius: 8px; border-left: 3px solid ${getActivityColor(a.type)};">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span class="activity-type" style="background: ${getActivityColor(a.type)}; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">${a.type}</span>
                    <span class="activity-title" style="font-weight: 600; color: #fff;">${a.title}</span>
                    <span class="activity-time" style="margin-left: auto; color: #888; font-size: 12px;">${a.estimatedMinutes}min</span>
                  </div>
                  ${renderActivityContent(a)}
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          ${lesson.keyPoints ? `
            <div class="lesson-keypoints">
              <h5>Key Points</h5>
              <ul>${lesson.keyPoints.map(kp => `<li>${kp}</li>`).join('')}</ul>
            </div>
          ` : ''}
          
          <div class="runner-actions" style="margin-top: 16px;">
            <button class="btn btn-success" onclick="completeSession('${lesson.id}')">âœ“ Complete Session</button>
            <button class="btn btn-secondary btn-sm" onclick="regenerateSession('${lesson.subskillId}', ${lesson.sessionNumber})">Regenerate</button>
          </div>
        </div>
      `;
    }
    
    function renderKnowledgeCheck(check) {
      return `
        <div class="runner-section" style="border-color: #f59e0b; background: #2e2a1a;">
          <h4>âš¡ Knowledge Check (Attempt ${check.attemptNumber})</h4>
          <p style="color: #888;">Answer 70% correctly to advance.</p>
          
          <div class="kc-questions">
            ${check.questions.map((q, i) => `
              <div class="kc-question" data-id="${q.id}">
                <div class="kc-question-text">${i + 1}. ${q.question}</div>
                ${q.type === 'multiple_choice' ? `
                  <div class="kc-options">
                    ${q.options.map(opt => `
                      <label class="kc-option">
                        <input type="radio" name="q_${q.id}" value="${opt}">
                        <span>${opt}</span>
                      </label>
                    `).join('')}
                  </div>
                ` : q.type === 'true_false' ? `
                  <div class="kc-options">
                    <label class="kc-option"><input type="radio" name="q_${q.id}" value="true"><span>True</span></label>
                    <label class="kc-option"><input type="radio" name="q_${q.id}" value="false"><span>False</span></label>
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
          
          <div class="runner-actions" style="margin-top: 16px;">
            <button class="btn btn-success" onclick="submitKnowledgeCheck('${check.id}')">Submit Answers</button>
          </div>
        </div>
      `;
    }
    
    // Runner API Functions
    
    async function startSubskill(subskillId) {
      try {
        const result = await request('POST', `/sword/runner/subskill/${subskillId}/start`);
        alert(`Route Type: ${result.routeType}\n\nSubskill: ${result.subskill?.title}\n\nHas Lesson Plan: ${!!result.lessonPlan}\nHas Assessment: ${!!result.assessment}`);
        loadRunner();
      } catch (error) {
        alert('Failed to start subskill: ' + error.message);
      }
    }
    
    async function startSession(subskillId) {
      try {
        const result = await request('POST', '/sword/runner/session/start', { subskillId });
        state.runnerDailyLesson = result.dailyLesson;
        renderRunner();
      } catch (error) {
        alert('Failed to start session: ' + error.message);
      }
    }
    
    async function completeSession(dailyLessonId) {
      try {
        const result = await request('POST', `/sword/runner/session/${dailyLessonId}/complete`);
        state.runnerDailyLesson = null;
        alert(`Session ${result.sessionCompleted}/${result.totalSessions} completed!\n\nSubskill Complete: ${result.isSubskillComplete}\nKnowledge Check Next: ${result.isKnowledgeCheckNext}\nPlan Complete: ${result.isPlanComplete}`);
        loadRunner();
      } catch (error) {
        alert('Failed to complete session: ' + error.message);
      }
    }
    
    async function regenerateSession(subskillId, sessionNumber) {
      try {
        const result = await request('POST', `/sword/runner/session/${subskillId}/${sessionNumber}/regenerate`);
        state.runnerDailyLesson = result;
        renderRunner();
      } catch (error) {
        alert('Failed to regenerate session: ' + error.message);
      }
    }
    
    async function getKnowledgeCheck(subskillId) {
      try {
        const check = await request('GET', `/sword/runner/check/${subskillId}`);
        state.runnerKnowledgeCheck = check;
        renderRunner();
      } catch (error) {
        alert('Failed to get knowledge check: ' + error.message);
      }
    }
    
    async function submitKnowledgeCheck(checkId) {
      try {
        // Gather answers from form
        const answers = [];
        const check = state.runnerKnowledgeCheck;
        
        for (const q of check.questions) {
          const selected = document.querySelector(`input[name="q_${q.id}"]:checked`);
          if (selected) {
            answers.push({ questionId: q.id, answer: selected.value });
          }
        }
        
        if (answers.length < check.questions.length) {
          alert('Please answer all questions');
          return;
        }
        
        const result = await request('POST', '/sword/runner/check/submit', { checkId, answers });
        state.runnerKnowledgeCheck = null;
        
        if (result.passed) {
          alert(`âœ… PASSED! Score: ${result.score}%\n\nNext Subskill: ${result.nextSubskill?.title || 'None'}\nPlan Complete: ${result.isPlanComplete}`);
        } else {
          const missed = result.missedQuestions?.map(m => `â€¢ ${m.question}\n  Your answer: ${m.userAnswer}\n  Correct: ${m.correctAnswer}`).join('\n\n');
          alert(`âŒ Not Passed. Score: ${result.score}%\n\nMissed Questions:\n${missed}\n\nYou can retake the test.`);
        }
        
        loadRunner();
      } catch (error) {
        alert('Failed to submit knowledge check: ' + error.message);
      }
    }
    
    async function getSubskillProgress(subskillId) {
      try {
        const progress = await request('GET', `/sword/runner/progress/subskill/${subskillId}`);
        alert(`Progress: ${progress.sessionsCompleted}/${progress.totalSessions} sessions (${Math.round(progress.progress * 100)}%)\n\nSummaries:\n${progress.summaries.map(s => `Session ${s.sessionNumber}: ${s.summary}`).join('\n') || 'None yet'}`);
      } catch (error) {
        alert('Failed to get progress: ' + error.message);
      }
    }
    
    async function getRefreshContent(subskillId) {
      try {
        const content = await request('GET', `/sword/runner/refresh/${subskillId}/content`);
        alert(`Refresh Content:\n\n${content.summary}\n\nRecall Questions:\n${content.recallQuestions?.map((q, i) => `${i+1}. ${q}`).join('\n')}\n\nEstimated: ${content.estimatedMinutes} minutes`);
      } catch (error) {
        alert('Failed to get refresh content: ' + error.message);
      }
    }
    
    async function skipRefresh(subskillId) {
      try {
        await request('POST', `/sword/runner/refresh/${subskillId}/skip`);
        loadRunner();
      } catch (error) {
        alert('Failed to skip refresh: ' + error.message);
      }
    }
    
    async function refreshRunner() {
      await loadRunner();
    }
  </script>
</body>
</html>
