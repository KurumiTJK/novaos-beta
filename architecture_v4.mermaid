---
config:
  layout: dagre
title: NovaOS v4 â€” Execution Pipeline Architecture
---
flowchart TB
 subgraph Input["INPUT LAYER"]
        UI["User Interface"]
        API["API Endpoint"]
        CMD["Command Parser"]
  end
 subgraph Sources["ACTION SOURCES (Explicit Only)"]
        Actions["RequestedActions"]
  end
 subgraph IntentGate["INTENT GATE"]
        IG_Classify["Classify Intent"]
        IG_In["Input"]
        IG_Out["Intent"]
        Stop1["STOP"]
        IG_Fail["Hard Fail: Unparseable"]
  end
 subgraph ShieldGate["SHIELD GATE âš”ï¸"]
        SG_Risk["Assess Risk"]
        SG_In["Intent"]
        SG_Check{"Veto?"}
        SG_HardVeto["Hard Veto"]
        SG_SoftVeto["Soft Veto"]
        SG_Pass["Pass"]
        Stop2["STOP"]
        AwaitAck["AWAIT_ACK"]
        SG_Control{"Control Trigger?"}
        SG_Resources["Mark: requiredPrependResources"]
        SG_Out["RiskSummary"]
  end
 subgraph LensGate["LENS GATE ðŸ”"]
        LG_Check["Check Verification Required"]
        LG_In["RiskSummary"]
        LG_Triggers{"Triggers?"}
        LG_Skip["Skip Verification"]
        LG_CanVerify{"Can Verify?"}
        LG_Verify["Execute Verification"]
        LG_Stakes{"Stakes Level?"}
        LG_Options["Return User Options"]
        LG_Degrade["Degrade"]
        Stop3["STOP"]
        LG_Restrict["No Numerics, No Actions"]
        LG_Out["VerificationPlan"]
  end
 subgraph StanceGate["STANCE GATE"]
        STG_Select["Select Stance"]
        STG_In["VerificationPlan"]
        STG_Out["Stance"]
  end
 subgraph CapabilityGate["CAPABILITY GATE"]
        CG_Check["Check Actions vs Matrix"]
        CG_In["Stance"]
        CG_Blocked{"Blocked?"}
        Stop4["STOP"]
        CG_Out["CapabilityCheckResult"]
  end
 subgraph ModelGate["MODEL GATE ðŸ¤–"]
        MG_Constraints["Build Constraints"]
        MG_In["CapabilityCheckResult"]
        MG_Generate["Generate Response"]
        MG_Out["GenerationResult"]
        Stop5["STOP"]
        MG_Fail["Hard Fail: All Models Down"]
  end
 subgraph PersonalityGate["PERSONALITY GATE"]
        PG_Validate["Validate Output"]
        PG_In["GenerationResult"]
        PG_Severity{"Violations?"}
        PG_Regen["REGENERATE"]
        PG_Edit["Surgical Edit"]
        PG_Out["ValidatedOutput"]
  end
 subgraph SparkGate["SPARK GATE âš¡"]
        SPG_Check{"Stance = Sword?"}
        SPG_In["ValidatedOutput"]
        SPG_NoSpark["spark: null"]
        SPG_Eligible{"Eligible?"}
        SPG_Generate["Generate Spark"]
        SPG_Out["SparkDecision"]
  end
 subgraph Pipeline["EXECUTION PIPELINE"]
    direction TB
        IntentGate
        ShieldGate
        LensGate
        StanceGate
        CapabilityGate
        ModelGate
        PersonalityGate
        SparkGate
  end
 subgraph Output["OUTPUT LAYER"]
        Response["Build Response"]
        Audit["Audit Logger"]
        Invariants["Invariant Checker"]
        UI_Out["User Interface"]
  end
 subgraph AckFlow["SOFT VETO ACKNOWLEDGMENT FLOW"]
        AckUI["Show Ack Dialog"]
        UserTypes["User Types Exact Phrase"]
        VerifyToken["Verify ackToken + Text"]
        LogOverride["Log Override"]
  end
 subgraph Constraints["GENERATION CONSTRAINTS"]
        C1["bannedPhrases"]
        C2["maxWe"]
        C3["numericPrecisionAllowed"]
        C4["actionRecommendationsAllowed"]
        C5["mustInclude"]
        C6["mustNotInclude"]
        C7["mustPrepend"]
  end
 subgraph Invariants_List["INVARIANTS (Must Never Break)"]
        I1["hard_veto_stops"]
        I2["sword_only_spark"]
        I3["lens_degradation"]
        I4["control_resources"]
        I5["regeneration_limit"]
        I6["soft_veto_ack"]
        I7["no_nl_actions"]
        I8["immediate_domain_numerics"]
  end
    UI -- source: ui_button --> Actions
    API -- source: api_field --> Actions
    CMD -- source: command_parser --> Actions
    IG_In --> IG_Classify
    IG_Classify --> IG_Out
    IG_Fail -.-> Stop1
    SG_In --> SG_Risk
    SG_Risk --> SG_Check
    SG_Check -- Hard --> SG_HardVeto
    SG_Check -- Soft --> SG_SoftVeto
    SG_Check -- No --> SG_Pass
    SG_HardVeto --> Stop2
    SG_SoftVeto --> AwaitAck
    SG_Pass --> SG_Control
    SG_Control -- Yes --> SG_Resources
    SG_Control -- No --> SG_Out
    SG_Resources --> SG_Out
    LG_In --> LG_Check
    LG_Check --> LG_Triggers
    LG_Triggers -- None --> LG_Skip
    LG_Triggers -- Required --> LG_CanVerify
    LG_CanVerify -- Yes --> LG_Verify
    LG_CanVerify -- No --> LG_Stakes
    LG_Stakes -- High/Critical --> LG_Options
    LG_Stakes -- Low/Medium --> LG_Degrade
    LG_Options --> Stop3
    LG_Degrade --> LG_Restrict
    LG_Skip --> LG_Out
    LG_Verify --> LG_Out
    LG_Restrict --> LG_Out
    STG_In --> STG_Select
    STG_Select --> STG_Out
    CG_In --> CG_Check
    CG_Check --> CG_Blocked
    CG_Blocked -- Yes --> Stop4
    CG_Blocked -- No --> CG_Out
    MG_In --> MG_Constraints
    MG_Constraints --> MG_Generate
    MG_Generate --> MG_Out
    MG_Fail -.-> Stop5
    PG_In --> PG_Validate
    PG_Validate --> PG_Severity
    PG_Severity -- High --> PG_Regen
    PG_Severity -- Low/Med --> PG_Edit
    PG_Severity -- None --> PG_Out
    PG_Edit --> PG_Out
    PG_Regen --> MG_In
    SPG_In --> SPG_Check
    SPG_Check -- No --> SPG_NoSpark
    SPG_Check -- Yes --> SPG_Eligible
    SPG_Eligible -- No --> SPG_NoSpark
    SPG_Eligible -- Yes --> SPG_Generate
    SPG_NoSpark --> SPG_Out
    SPG_Generate --> SPG_Out
    IntentGate --> ShieldGate
    ShieldGate --> LensGate
    LensGate --> StanceGate
    StanceGate --> CapabilityGate
    CapabilityGate --> ModelGate
    ModelGate --> PersonalityGate
    PersonalityGate --> SparkGate
    SPG_Out --> Response
    Response --> Audit & Invariants
    Invariants --> UI_Out
    AwaitAck --> AckUI
    AckUI --> UserTypes
    UserTypes --> VerifyToken
    VerifyToken --> LogOverride
    LogOverride --> SG_Pass
    UI --> Input
    Actions --> Pipeline

     Stop1:::stop
     Stop2:::stop
     AwaitAck:::await
     Stop3:::stop
     Stop4:::stop
     Stop5:::stop
     IntentGate:::gate
     ShieldGate:::gate
     LensGate:::gate
     StanceGate:::gate
     CapabilityGate:::gate
     ModelGate:::gate
     PersonalityGate:::gate
     SparkGate:::gate
    classDef gate fill:#f5f5f0,stroke:#333,stroke-width:2px
    classDef stop fill:#a35a5a,stroke:#333,color:#fff
    classDef await fill:#9a8a5a,stroke:#333,color:#fff
    classDef pass fill:#7a9a6b,stroke:#333,color:#fff